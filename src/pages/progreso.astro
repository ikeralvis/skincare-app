---
// src/pages/progreso.astro
import Header from '../components/Header.astro';
import AuthModal from '../components/AuthModal.astro';
import BottomNav from '../components/BottomNav.astro';
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Progreso - Skincare App</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <style>
      @font-face {
        font-family: "Phatt";
        src: url("/fonts/Phatt-Regular.woff2") format("woff2");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        color: white;
        min-height: 100vh;
        overflow-x: hidden;
      }

      .main-content {
        padding: 1rem;
        padding-top: 80px;
        max-width: 600px;
        margin: 0 auto;
      }

      .page-title {
        font-family: "Phatt", sans-serif;
        font-size: 2rem;
        color: #00ffff;
        text-align: center;
        margin-bottom: 2rem;
        text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      }

      /* Tarjeta de racha principal */
      .streak-card {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
        box-shadow: 0 8px 30px rgba(255, 107, 107, 0.4);
        position: relative;
        overflow: hidden;
      }

      .streak-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: pulse 3s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 0.8; }
      }

      .streak-icon {
        font-size: 4rem;
        margin-bottom: 0.5rem;
        animation: flicker 2s ease-in-out infinite;
      }

      @keyframes flicker {
        0%, 100% { transform: scale(1); filter: brightness(1); }
        50% { transform: scale(1.1); filter: brightness(1.3); }
      }

      .streak-number {
        font-size: 3.5rem;
        font-weight: bold;
        line-height: 1;
        margin-bottom: 0.25rem;
      }

      .streak-label {
        font-size: 1.2rem;
        opacity: 0.95;
        font-weight: 500;
      }

      .streak-message {
        margin-top: 1rem;
        font-size: 1rem;
        font-weight: 500;
        opacity: 0.9;
      }

      /* Tarjetas de estad√≠sticas */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        padding: 1.5rem 1rem;
        text-align: center;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        border-color: #00ffff;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        transform: translateY(-4px);
      }

      .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #00ffff;
        line-height: 1;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
      }

      /* Barra de progreso semanal */
      .progress-section {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .progress-title {
        font-size: 1.1rem;
        color: #00ffff;
        margin-bottom: 1rem;
        font-weight: 600;
      }

      .progress-bar-container {
        width: 100%;
        height: 30px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        margin-bottom: 0.5rem;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #00ffff 0%, #00dddd 100%);
        border-radius: 15px;
        transition: width 1s ease;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        position: relative;
      }

      .progress-bar-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      .progress-text {
        text-align: center;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.8);
      }

      /* Calendario mini (opcional para futuro) */
      .calendar-preview {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .calendar-title {
        font-size: 1.1rem;
        color: #00ffff;
        margin-bottom: 1rem;
        font-weight: 600;
      }

      .week-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
      }

      .day-cell {
        aspect-ratio: 1;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
      }

      .day-cell.completed {
        background: linear-gradient(135deg, #00ff88 0%, #00ddaa 100%);
        border-color: #00ff88;
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
      }

      .day-cell.partial {
        background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
        border-color: #ffaa00;
      }

      .day-cell.today {
        border: 2px solid #00ffff;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      }

      .day-name {
        font-size: 0.65rem;
        opacity: 0.7;
        margin-bottom: 0.25rem;
      }

      /* Loading state */
      .loading {
        text-align: center;
        padding: 2rem;
        color: #00ffff;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 255, 255, 0.2);
        border-top-color: #00ffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Responsive */
      @media (max-width: 480px) {
        .page-title {
          font-size: 1.5rem;
        }
        .streak-icon {
          font-size: 3rem;
        }
        .streak-number {
          font-size: 2.5rem;
        }
        .stats-grid {
          gap: 0.75rem;
        }
        .stat-card {
          padding: 1rem 0.75rem;
        }
      }
    </style>
  </head>
  <body>
    <AuthModal />
    <Header />

    <main class="main-content">
      <h1 class="page-title">Tu Progreso</h1>

      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>Cargando estad√≠sticas...</p>
      </div>

      <div id="progress-content" style="display: none;">
        <!-- Tarjeta principal de racha -->
        <div class="streak-card">
          <div class="streak-icon">üî•</div>
          <div class="streak-number" id="streak-number">0</div>
          <div class="streak-label">d√≠as de racha</div>
          <div class="streak-message" id="streak-message">¬°Sigue as√≠!</div>
        </div>

        <!-- Grid de estad√≠sticas -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-number" id="longest-streak">0</div>
            <div class="stat-label">R√©cord Personal</div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">‚ú®</div>
            <div class="stat-number" id="total-completions">0</div>
            <div class="stat-label">Total Completadas</div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-number" id="days-active">0</div>
            <div class="stat-label">D√≠as Activos</div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">üí™</div>
            <div class="stat-number" id="completion-rate">0%</div>
            <div class="stat-label">Tasa de √âxito</div>
          </div>
        </div>

        <!-- Progreso semanal -->
        <div class="progress-section">
          <div class="progress-title">Progreso esta semana</div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progress-bar" style="width: 0%"></div>
          </div>
          <div class="progress-text" id="progress-text">0 de 14 rutinas completadas</div>
        </div>

        <!-- Mini calendario de √∫ltima semana -->
        <div class="calendar-preview">
          <div class="calendar-title">√öltimos 7 d√≠as</div>
          <div class="week-grid" id="week-calendar">
            <!-- Se llena din√°micamente -->
          </div>
        </div>
      </div>
    </main>

    <BottomNav />

    <script>
      import { auth } from '../utils/firebase';
      import { onAuthStateChanged } from 'firebase/auth';
      import { getProgressData } from '../utils/firebase';

      // Esperar a que Firebase Auth inicialice
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          // No hay usuario autenticado
          const loadingEl = document.getElementById('loading');
          if (loadingEl) {
            loadingEl.innerHTML = `
              <p style="margin-bottom: 1rem;">üîí Inicia sesi√≥n para ver tu progreso</p>
              <button 
                onclick="window.dispatchEvent(new CustomEvent('open-auth-modal'))"
                style="
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  border: none;
                  padding: 1rem 2rem;
                  border-radius: 12px;
                  font-size: 1rem;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.3s ease;
                "
              >
                Iniciar Sesi√≥n
              </button>
            `;
          }
          return;
        }

        // Usuario autenticado, cargar datos
        try {
          const progressData = await getProgressData();
          
          if (!progressData) {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
              loadingEl.innerHTML = `<p>Error cargando datos. Intenta de nuevo.</p>`;
            }
            return;
          }

          // Ocultar loading y mostrar contenido
          const loadingEl = document.getElementById('loading');
          const contentEl = document.getElementById('progress-content');
          if (loadingEl) loadingEl.style.display = 'none';
          if (contentEl) contentEl.style.display = 'block';

          // Actualizar racha actual
          const streakNumber = document.getElementById('streak-number');
          if (streakNumber) {
            streakNumber.textContent = String(progressData.currentStreak);
          }

          // Mensaje motivacional seg√∫n racha
          const streakMessage = document.getElementById('streak-message');
          if (streakMessage) {
            if (progressData.currentStreak === 0) {
              streakMessage.textContent = '¬°Comienza tu racha hoy!';
            } else if (progressData.currentStreak < 3) {
              streakMessage.textContent = '¬°Buen comienzo! üí™';
            } else if (progressData.currentStreak < 7) {
              streakMessage.textContent = '¬°Vas muy bien! üåü';
            } else if (progressData.currentStreak < 30) {
              streakMessage.textContent = '¬°Incre√≠ble constancia! üöÄ';
            } else {
              streakMessage.textContent = '¬°Eres una leyenda! üëë';
            }
          }

          // Actualizar r√©cord personal
          const longestStreakEl = document.getElementById('longest-streak');
          if (longestStreakEl) {
            longestStreakEl.textContent = String(progressData.longestStreak);
          }

          // Total completadas
          const totalCompletionsEl = document.getElementById('total-completions');
          if (totalCompletionsEl) {
            totalCompletionsEl.textContent = String(progressData.totalCompletions);
          }

          // D√≠as activos (d√≠as √∫nicos con al menos una rutina)
          const daysActive = Object.keys(progressData.completions).length;
          const daysActiveEl = document.getElementById('days-active');
          if (daysActiveEl) {
            daysActiveEl.textContent = String(daysActive);
          }

          // Tasa de √©xito (completadas / d√≠as activos * 2 rutinas/d√≠a)
          const possibleCompletions = daysActive * 2; // 2 rutinas por d√≠a
          const completionRate = possibleCompletions > 0 
            ? Math.round((progressData.totalCompletions / possibleCompletions) * 100)
            : 0;
          const completionRateEl = document.getElementById('completion-rate');
          if (completionRateEl) {
            completionRateEl.textContent = `${completionRate}%`;
          }

          // Progreso semanal (√∫ltimos 7 d√≠as)
          const today = new Date();
          const last7Days = [];
          let weekCompletions = 0;
          
          for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            last7Days.push({ date: dateStr, data: progressData.completions[dateStr] });
            
            const dayData = progressData.completions[dateStr];
            if (dayData) {
              if (dayData.morning?.completed) weekCompletions++;
              if (dayData.night?.completed) weekCompletions++;
            }
          }

          const weekPercentage = (weekCompletions / 14) * 100;
          const progressBarEl = document.getElementById('progress-bar');
          if (progressBarEl) {
            progressBarEl.style.width = `${weekPercentage}%`;
          }
          const progressTextEl = document.getElementById('progress-text');
          if (progressTextEl) {
            progressTextEl.textContent = `${weekCompletions} de 14 rutinas completadas`;
          }

          // Mini calendario de √∫ltima semana
          const weekCalendar = document.getElementById('week-calendar');
          const dayNames = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
          
          if (weekCalendar) {
            last7Days.forEach((day, index) => {
              const cell = document.createElement('div');
              cell.className = 'day-cell';
              
              const dayData = day.data;
              const morningDone = dayData?.morning?.completed;
              const nightDone = dayData?.night?.completed;
              
              if (morningDone && nightDone) {
                cell.classList.add('completed');
                cell.innerHTML = `<span class="day-name">${dayNames[new Date(day.date).getDay()]}</span>‚úÖ`;
              } else if (morningDone || nightDone) {
                cell.classList.add('partial');
                cell.innerHTML = `<span class="day-name">${dayNames[new Date(day.date).getDay()]}</span>‚ö°`;
              } else {
                cell.innerHTML = `<span class="day-name">${dayNames[new Date(day.date).getDay()]}</span>-`;
              }
              
              // Marcar hoy
              if (index === 6) {
                cell.classList.add('today');
              }
              
              weekCalendar.appendChild(cell);
            });
          }

        } catch (error) {
          console.error('Error cargando progreso:', error);
          const loadingEl = document.getElementById('loading');
          if (loadingEl) {
            loadingEl.innerHTML = `<p>Error cargando datos. Intenta de nuevo.</p>`;
          }
        }
      });
    </script>
  </body>
</html>
