---
export const prerender = false; // Desactivar prerender para contenido dinÃ¡mico
import {
  dailyRoutine,
  nightlyRoutineWithLactic,
  nightlyRoutineWithoutLactic,
} from "../data/routines";
import Header from "../components/Header.astro";
import Calendar from "../components/Calendar.astro";
import ProductCard from "../components/ProductCard.astro";

const now = new Date();
// ðŸ”¹ Hora de Madrid
const madridHourStr = new Intl.DateTimeFormat("es-ES", {
  timeZone: "Europe/Madrid",
  hour12: false,
  hour: "2-digit",
}).format(now);
const horaActual = parseInt(madridHourStr, 10);

// ðŸ”¹ DÃ­a de la semana en Madrid
const dayOfWeek = new Intl.DateTimeFormat("es-ES", {
  timeZone: "Europe/Madrid",
  weekday: "long",
})
  .format(now)
  .toLowerCase();

const isDayTime = horaActual >= 6 && horaActual < 20;
const isLacticAcidDay = ["lunes", "miÃ©rcoles", "viernes"].includes(dayOfWeek);

const currentRoutine = isDayTime
  ? dailyRoutine
  : isLacticAcidDay
    ? nightlyRoutineWithLactic
    : nightlyRoutineWithoutLactic;
const routineTitle = isDayTime ? "PROTOCOLO DIURNO" : "PROTOCOLO NOCTURNO";

const jsDateKey =
  now.getFullYear() +
  "-" +
  (now.getMonth() + 1).toString().padStart(2, "0") +
  "-" +
  now.getDate().toString().padStart(2, "0");

const jsRoutineType = isDayTime ? "diurno" : "nocturno";
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GuÃ­a de Skincare</title>
    <link rel="manifest" href="/manifest.webmanifest" />
    <style>
      body {
        margin: 0;
        background-color: #000;
        color: #fff;
        font-family: "Space Mono", monospace;
        min-height: 100vh;
        background-image: radial-gradient(circle, #1a2a47, #000);
      }
      .intro-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 95%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        opacity: 1;
        transition:
          opacity 1s,
          visibility 1s;
        z-index: 100;
      }
      .intro-screen.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }
      h1 {
        font-size: 2.5rem;
        margin-bottom: 2rem;
        animation: scan-text 1s linear infinite alternate;
      }
      .iris-scan {
        width: 50px;
        height: 50px;
        border: 2px solid #00ffff;
        border-radius: 50%;
        animation: iris-pulse 2s ease-in-out infinite;
      }
      @keyframes iris-pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 10px #00ffff;
        }
        100% {
          transform: scale(1.5);
          box-shadow: 0 0 20px #00ffff;
        }
      }
      @keyframes scan-text {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(-5px);
        }
      }
      .main-content {
        max-width: 600px;
        margin: 0 auto;
        padding: 1rem;
        display: none;
        padding-top: 100px;
      }
      .routine-title {
        text-align: center;
        margin-bottom: 2rem;
        font-size: 2rem;
        color: #00ffff;
      }
      .hidden {
        display: none !important;
      }
      .centered-button {
        display: flex;
        justify-content: center;
      }
      /* ðŸ”‘ ESTILO MEJORADO DEL BOTÃ“N */
      #mark-completed {
        padding: 12px 24px;
        font-size: 1.1rem;
        color: #000;
        background-color: #00ffff;
        border: 2px solid #00ffff;
        border-radius: 8px;
        cursor: pointer;
        transition:
          background-color 0.2s,
          color 0.2s,
          box-shadow 0.2s;
        text-transform: uppercase;
        font-weight: bold;
      }
      #mark-completed:hover {
        background-color: #00dddd;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
      }
      #mark-completed:active {
        background-color: #00bbbb;
        transform: translateY(1px);
      }

      /* Estilos de la lista de productos en columna */
      .product-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="intro-screen" class="intro-screen">
      <h1>Bienvenido a la guÃ­a de Skin Care</h1>
      <div class="iris-scan"></div>
    </div>

    <main id="main-content" class="main-content">
      <Header />

      <div id="guide-view">
        <h1 class="routine-title">{routineTitle}</h1>
        <!-- CONTROLES DE RECORDATORIO -->
        <div id="reminder-controls" style="margin-top:1rem; text-align:center;">
          <p style="margin-bottom:8px; color: #ccc;">Recordatorios</p>

          <div
            style="display:flex;gap:8px;justify-content:center;margin-bottom:8px"
          >
            <button
              id="rem-10"
              style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer"
              >10 min</button
            >
            <button
              id="rem-30"
              style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer"
              >30 min</button
            >
            <button
              id="rem-60"
              style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer"
              >1 h</button
            >
          </div>

          <form
            id="rem-custom-form"
            style="display:flex;gap:8px;justify-content:center;align-items:center;"
          >
            <input
              name="minutes"
              type="number"
              placeholder="Minutos"
              min="1"
              style="width:90px;padding:6px;border-radius:6px;border:1px solid #333;background:transparent;color:#fff;"
            />
            <button
              type="submit"
              style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer"
              >Programar</button
            >
          </form>

          <div
            id="reminders-list"
            style="margin-top:12px; max-width:480px; margin-left:auto; margin-right:auto; color:#ddd; font-size:0.95rem;"
          >
          </div>
        </div>

        <div class="product-list">
          {
            currentRoutine.map((product) => (
              <ProductCard
                step={product.step}
                title={product.title}
                accessCode={product.accessCode}
                function={product.function}
                usage={product.usage}
                image={product.image}
              />
            ))
          }
        </div>
      </div>

      <div id="calendar-view" class="hidden">
        <Calendar />
      </div>
    </main>

    <script is:inline>
      // PWA FIX 2: Registro manual del Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/sw.js")
          .then((reg) =>
            console.log("Service Worker registrado con Ã©xito:", reg.scope)
          )
          .catch((err) =>
            console.error("Error al registrar Service Worker:", err)
          );
      } // FIN DEL FIX PWA

      document.addEventListener("DOMContentLoaded", () => {
        const introScreen = document.getElementById("intro-screen");
        const mainContent = document.getElementById("main-content");

        setTimeout(() => {
          introScreen.classList.add("hidden");
          setTimeout(() => {
            mainContent.style.display = "block";
          }, 1000);
        }, 3000);

        const navButtons = document.querySelectorAll(".main-nav .nav-link");
        const guideView = document.getElementById("guide-view");
        const calendarView = document.getElementById("calendar-view");

        navButtons.forEach((button) => {
          button.addEventListener("click", () => {
            navButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");

            if (button.dataset.view === "guide") {
              guideView.classList.remove("hidden");
              calendarView.classList.add("hidden");
            } else if (button.dataset.view === "calendar") {
              guideView.classList.add("hidden");
              calendarView.classList.remove("hidden");
            }
          });
        });
      });
    </script>

    <script is:inline>
      (function () {
        // nombre de la clave en localStorage
        const REMINDERS_KEY = "skincareReminders_v1";
        const sessionTimers = {}; // timeouts en memoria (no se serializan)

        // Helpers de storage
        function loadReminders() {
          try {
            return JSON.parse(localStorage.getItem(REMINDERS_KEY) || "[]");
          } catch (e) {
            console.error("Error parseando recordatorios", e);
            return [];
          }
        }
        function saveReminders(list) {
          localStorage.setItem(REMINDERS_KEY, JSON.stringify(list));
        }

        // Asegura registro de service worker (si existe)
        async function ensureSWReady() {
          if (!("serviceWorker" in navigator)) return null;
          try {
            return await navigator.serviceWorker.ready;
          } catch (e) {
            console.warn("Service Worker no listo", e);
            return null;
          }
        }

        // Pedir permiso de notificaciones si hace falta
        function requestNotificationPermission() {
          if (!("Notification" in window)) return Promise.resolve("denied");
          if (Notification.permission === "granted")
            return Promise.resolve("granted");
          if (Notification.permission === "denied")
            return Promise.resolve("denied");
          return Notification.requestPermission();
        }

        // Mostrar un toast en-app como fallback
        function showToast(text) {
          let t = document.getElementById("sk-toast");
          if (!t) {
            t = document.createElement("div");
            t.id = "sk-toast";
            Object.assign(t.style, {
              position: "fixed",
              bottom: "20px",
              left: "50%",
              transform: "translateX(-50%)",
              background: "#111",
              padding: "10px 14px",
              borderRadius: "8px",
              color: "#fff",
              zIndex: 9999,
              opacity: "1",
            });
            document.body.appendChild(t);
          }
          t.textContent = text;
          t.style.opacity = "1";
          clearTimeout(t._hideTimer);
          t._hideTimer = setTimeout(() => (t.style.opacity = "0"), 4000);
        }

        // Enviar notificaciÃ³n (intenta service worker, si no Notification())
        async function showNotification(title, body, data = {}) {
          if (!("Notification" in window)) {
            showToast(body || title);
            return;
          }

          const permission = Notification.permission;
          if (permission !== "granted") {
            showToast(body || title);
            return;
          }

          const reg = await ensureSWReady();
          const options = {
            body: body,
            tag: "skincare-reminder",
            renotify: false,
            data,
            // Ajusta iconos segÃºn tu PWA (aÃ±ade los archivos)
            icon: "/icons/icon-192.png",
            badge: "/icons/icon-72.png",
          };

          try {
            if (reg && typeof reg.showNotification === "function") {
              // Mostramos desde el SW cuando sea posible
              reg.showNotification(title, options);
            } else {
              new Notification(title, options);
            }
          } catch (e) {
            console.warn(
              "No se pudo mostrar notificaciÃ³n via SW, fallback a Notification",
              e
            );
            try {
              new Notification(title, options);
            } catch (err) {
              showToast(body || title);
            }
          }
        }

        // Disparar recordatorio (mark fired + notificaciÃ³n)
        async function fireReminder(reminder) {
          // Marca como fired
          const list = loadReminders();
          const idx = list.findIndex((r) => r.id === reminder.id);
          if (idx !== -1) {
            list[idx].fired = true;
            saveReminders(list);
          }
          if (sessionTimers[reminder.id]) {
            clearTimeout(sessionTimers[reminder.id]);
            delete sessionTimers[reminder.id];
          }

          const title = `Recordatorio Skincare`;
          const body = `Es hora de tu rutina: ${reminder.title || "Rutina"}`;
          await showNotification(title, body, { id: reminder.id });
          renderReminders();
        }

        // Programar timeout en memoria (si queda tiempo)
        function scheduleReminder(reminder) {
          const remaining = reminder.when - Date.now();
          if (remaining <= 0) {
            // si ya pasÃ³: disparar inmediatamente
            fireReminder(reminder);
            return;
          }
          const tid = setTimeout(() => fireReminder(reminder), remaining);
          sessionTimers[reminder.id] = tid;
        }

        // AÃ±adir recordatorio en X minutos
        function addReminderIn(minutes) {
          const titleElement = document.querySelector(".routine-title");
          const title = titleElement
            ? titleElement.textContent.trim()
            : "Rutina";
          const when = Date.now() + minutes * 60 * 1000;
          const reminder = {
            id: "r-" + Date.now(),
            when,
            minutes,
            title,
            fired: false,
          };

          const list = loadReminders();
          list.push(reminder);
          saveReminders(list);
          scheduleReminder(reminder);

          // Pedimos permiso (si el usuario acepta, la notificaciÃ³n saldrÃ¡)
          requestNotificationPermission().then((perm) => {
            if (perm !== "granted")
              showToast(
                "Permiso de notificaciones no concedido â€” usarÃ© un aviso en la app."
              );
            else showToast("Recordatorio programado âœ…");
          });

          renderReminders();
        }

        // Cancelar recordatorio
        function cancelReminder(id) {
          let list = loadReminders();
          list = list.filter((r) => r.id !== id);
          saveReminders(list);
          if (sessionTimers[id]) {
            clearTimeout(sessionTimers[id]);
            delete sessionTimers[id];
          }
          renderReminders();
        }

        // Render lista de recordatorios (simple)
        function renderReminders() {
          const container = document.getElementById("reminders-list");
          if (!container) return;
          const list = loadReminders().sort((a, b) => a.when - b.when);
          container.innerHTML = "";
          if (list.length === 0) {
            container.innerHTML =
              "<div style='opacity:0.5;color:#0ff;text-align:center'>No hay recordatorios activos</div>";
            return;
          }
          list.forEach((r) => {
            const div = document.createElement("div");
            div.className = "reminder-row";
            div.style =
              "display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-radius:8px;background:rgba(0,255,255,0.05);margin-bottom:8px;backdrop-filter:blur(4px);";

            const left = document.createElement("div");
            left.innerHTML = `<strong style="display:block;color:#0ff">${new Date(
              r.when
            ).toLocaleTimeString("es-ES", {
              hour: "2-digit",
              minute: "2-digit",
            })}</strong><small style="opacity:0.7;color:#ccc">${r.title}</small>`;

            const right = document.createElement("div");
            right.style = "display:flex;align-items:center;gap:6px";

            // âœ… Mostrar check si ya se disparÃ³
            if (r.fired) {
              const span = document.createElement("span");
              span.textContent = "enviado";
              span.style.color = "#0ff";
              span.style.fontSize = "0.85rem";
              span.style.opacity = "0.7";
              right.appendChild(span);
            }

            // âŒ BotÃ³n de eliminar siempre disponible
            const btnCancel = document.createElement("button");
            btnCancel.innerHTML = "âŒ";
            btnCancel.style =
              "padding:4px 8px;border-radius:6px;border:none;cursor:pointer;background:rgba(255,0,255,0.1);color:#ff5555;font-size:0.9rem;transition:0.2s;backdrop-filter:blur(2px)";
            btnCancel.title = "Eliminar recordatorio";
            btnCancel.addEventListener("mouseenter", () => {
              btnCancel.style.background = "rgba(255,0,255,0.3)";
              btnCancel.style.boxShadow = "0 0 6px #ff00ff";
            });
            btnCancel.addEventListener("mouseleave", () => {
              btnCancel.style.background = "rgba(255,0,255,0.1)";
              btnCancel.style.boxShadow = "none";
            });
            btnCancel.addEventListener("click", () => cancelReminder(r.id));
            right.appendChild(btnCancel);

            div.appendChild(left);
            div.appendChild(right);
            container.appendChild(div);
          });
        }

        // Inicializa: restaurar timers de localStorage
        function initReminders() {
          const list = loadReminders();
          list.forEach((r) => {
            if (!r.fired && r.when > Date.now()) scheduleReminder(r);
            else if (!r.fired && r.when <= Date.now()) {
              // algo quedÃ³ pendiente, lo disparamos al iniciar
              fireReminder(r);
            }
          });
          renderReminders();
        }

        // Wire UI (botones)
        document.addEventListener("DOMContentLoaded", () => {
          const btn10 = document.getElementById("rem-10");
          const btn30 = document.getElementById("rem-30");
          const btn60 = document.getElementById("rem-60");
          const form = document.getElementById("rem-custom-form");

          if (btn10) btn10.addEventListener("click", () => addReminderIn(10));
          if (btn30) btn30.addEventListener("click", () => addReminderIn(30));
          if (btn60) btn60.addEventListener("click", () => addReminderIn(60));
          if (form) {
            form.addEventListener("submit", (e) => {
              e.preventDefault();
              const minutes = parseInt(form.elements["minutes"].value, 10);
              if (!minutes || minutes <= 0)
                return showToast("Introduce un nÃºmero vÃ¡lido de minutos");
              addReminderIn(minutes);
              form.reset();
            });
          }

          initReminders();
        });

        // Exponer para debugging
        window.skincareReminders = {
          addReminderIn,
          loadReminders,
          cancelReminder,
        };
      })();
    </script>
  </body>
</html>
