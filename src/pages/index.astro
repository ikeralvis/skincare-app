---
export const prerender = false; // Desactivar prerender para contenido din√°mico
import {
  dailyRoutine as hardcodedDaily,
  nightlyRoutineWithLactic as hardcodedNightlyLactic,
  nightlyRoutineWithoutLactic as hardcodedNightlyWithout,
} from "../data/routines";
import { getRoutines, createEmptyRoutineData } from "../utils/firebase";
import type { RoutineData, Product } from "../types/routine";
import Header from "../components/Header.astro";
import Calendar from "../components/Calendar.astro";
import ProductCard from "../components/ProductCard.astro";
import RoutineEditor from "../components/RoutineEditor.astro";
import AuthModal from "../components/AuthModal.astro";
import BottomNav from "../components/BottomNav.astro";
import ReminderManager from "../components/ReminderManager.astro";
import AchievementsPanel from "../components/AchievementsPanel.astro";
import ChatWidget from "../components/ChatWidget.astro";

const now = new Date();
// üîπ Hora de Madrid
const madridHourStr = new Intl.DateTimeFormat("es-ES", {
  timeZone: "Europe/Madrid",
  hour12: false,
  hour: "2-digit",
}).format(now);
const horaActual = parseInt(madridHourStr, 10);

// üîπ D√≠a de la semana en Madrid
const dayOfWeek = new Intl.DateTimeFormat("es-ES", {
  timeZone: "Europe/Madrid",
  weekday: "long",
})
  .format(now)
  .toLowerCase();

const isDayTime = horaActual >= 6 && horaActual < 22;
const capitalizedDay = dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1);

// Cargar rutinas desde Firebase
let routineData: RoutineData;
let currentRoutine: Product[];

try {
  const data = await getRoutines();
  routineData = data || createEmptyRoutineData();

  if (isDayTime) {
    currentRoutine = routineData.dailyRoutine
      .filter((p) => p.enabled)
      .sort((a, b) => a.step - b.step);
  } else {
    currentRoutine = (routineData.nightlyRoutines[capitalizedDay] || [])
      .filter((p) => p.enabled)
      .sort((a, b) => a.step - b.step);
  }

  // Si no hay rutinas guardadas, usar las hardcoded como fallback
  if (currentRoutine.length === 0) {
    const isLacticAcidDay = ["lunes", "mi√©rcoles", "viernes"].includes(
      dayOfWeek,
    );
    const hardcodedRoutine = isDayTime
      ? hardcodedDaily
      : isLacticAcidDay
        ? hardcodedNightlyLactic
        : hardcodedNightlyWithout;

    // Convertir al formato Product
    currentRoutine = hardcodedRoutine.map((item, index) => ({
      ...item,
      id: `fallback-${index}`,
      routineType: isDayTime ? ("day" as const) : ("night" as const),
      frequency: "daily" as const,
      enabled: true,
    }));
  }
} catch (error) {
  console.error("Error cargando rutinas:", error);
  // Fallback a rutinas hardcoded
  const isLacticAcidDay = ["lunes", "mi√©rcoles", "viernes"].includes(dayOfWeek);
  const hardcodedRoutine = isDayTime
    ? hardcodedDaily
    : isLacticAcidDay
      ? hardcodedNightlyLactic
      : hardcodedNightlyWithout;

  // Convertir al formato Product
  currentRoutine = hardcodedRoutine.map((item, index) => ({
    ...item,
    id: `fallback-${index}`,
    routineType: isDayTime ? ("day" as const) : ("night" as const),
    frequency: "daily" as const,
    enabled: true,
  }));
}

const routineTitle = isDayTime ? "PROTOCOLO DIURNO" : "PROTOCOLO NOCTURNO";

// Variables para uso futuro si se necesitan
// const jsDateKey =
//   now.getFullYear() +
//   "-" +
//   (now.getMonth() + 1).toString().padStart(2, "0") +
//   "-" +
//   now.getDate().toString().padStart(2, "0");

// const jsRoutineType = isDayTime ? "diurno" : "nocturno";
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gu√≠a de Skincare</title>
    <link rel="manifest" href="/manifest.webmanifest" />
    <style>
      body {
        margin: 0;
        background-color: #000;
        color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        min-height: 100vh;
        background: linear-gradient(135deg, #0f0c29 0%, #1a1a2e 100%);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* OPTIMIZACIONES GLOBALES PARA RENDIMIENTO */
      * {
        -webkit-tap-highlight-color: transparent;
      }

      /* Optimizaci√≥n para m√≥viles: desactivar efectos pesados */
      @media (max-width: 768px) {
        * {
          backdrop-filter: none !important;
          -webkit-backdrop-filter: none !important;
        }

        /* Desactivar animaciones pesadas */
        .streak-card::before,
        .progress-bar-fill::after {
          display: none !important;
          animation: none !important;
        }

        /* Fondos s√≥lidos optimizados */
        .mobile-logo,
        .stat-card,
        .progress-section,
        .calendar-preview,
        .manual-register-card {
          background: rgba(15, 15, 30, 0.95) !important;
          backdrop-filter: none !important;
        }

        .toast {
          background: #1a1a2e !important;
          border: 2px solid #00ffff !important;
        }

        /* Transiciones solo esenciales */
        .intro-screen {
          transition: opacity 0.3s ease !important;
        }

        /* Reducir sombras */
        .streak-card,
        .stat-card,
        .manual-register-card {
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }
      }

      /* === FORMULARIO REGISTRO MANUAL === */
      .manual-register-card {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
        border: 2px solid rgba(102, 126, 234, 0.4);
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .manual-register-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }

      .manual-register-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        color: #a78bfa;
        margin: 0;
      }

      .manual-register-toggle {
        background: rgba(167, 139, 250, 0.2);
        border: 1px solid rgba(167, 139, 250, 0.4);
        border-radius: 8px;
        padding: 0.4rem 0.75rem;
        color: #a78bfa;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .manual-register-toggle:hover {
        background: rgba(167, 139, 250, 0.3);
      }

      .manual-register-form {
        display: none;
      }

      .manual-register-form.visible {
        display: block;
      }

      .form-row {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
      }

      .form-group {
        flex: 1;
        min-width: 140px;
      }

      .form-label {
        display: block;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 0.35rem;
      }

      .form-input {
        width: 100%;
        padding: 0.65rem 0.75rem;
        background: rgba(0, 0, 0, 0.4);
        border: 1.5px solid rgba(167, 139, 250, 0.3);
        border-radius: 10px;
        color: white;
        font-size: 1rem;
        box-sizing: border-box;
        -webkit-appearance: none;
        appearance: none;
      }

      .form-input:focus {
        outline: none;
        border-color: #a78bfa;
      }

      .form-input[type="date"] {
        color-scheme: dark;
      }

      .checkbox-group {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.85rem 1rem;
        background: linear-gradient(135deg, rgba(20, 20, 40, 0.9) 0%, rgba(30, 30, 50, 0.9) 100%);
        border: 1.5px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        flex: 1;
        min-width: 120px;
        justify-content: center;
        -webkit-tap-highlight-color: transparent;
      }

      .checkbox-item:active {
        background: rgba(0, 255, 255, 0.1);
      }

      .checkbox-item:has(input:checked) {
        background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(0, 200, 200, 0.15) 100%);
        border-color: #00ffff;
      }

      .checkbox-item input {
        display: none;
      }

      .checkbox-item span {
        font-size: 0.95rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
      }

      .checkbox-icon {
        font-size: 1.2rem;
      }

      .submit-manual-btn {
        width: 100%;
        padding: 0.85rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        transition: transform 0.15s ease, opacity 0.15s ease;
      }

      .submit-manual-btn:active {
        transform: scale(0.98);
      }

      .submit-manual-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Acceso r√°pido d√≠as recientes */
      .quick-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.4rem;
        margin-bottom: 1rem;
      }

      .quick-day-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 0.25rem;
        background: linear-gradient(135deg, rgba(20, 20, 40, 0.9) 0%, rgba(30, 30, 50, 0.9) 100%);
        border: 1.5px solid rgba(0, 255, 255, 0.25);
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.75rem;
        cursor: pointer;
        text-align: center;
        min-height: 52px;
        -webkit-tap-highlight-color: transparent;
      }

      .quick-day-btn:active {
        background: rgba(0, 255, 255, 0.15);
        border-color: #00ffff;
      }

      .quick-day-btn.selected {
        background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(0, 200, 200, 0.15) 100%);
        border-color: #00ffff;
        color: #00ffff;
      }

      .quick-day-btn .day-name {
        display: block;
        font-weight: 600;
        font-size: 0.7rem;
        margin-bottom: 2px;
        color: #00ffff;
      }

      .quick-day-btn .day-date {
        font-size: 1rem;
        font-weight: 700;
        line-height: 1;
      }

      .intro-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        opacity: 1;
        transition: opacity 0.5s ease;
        z-index: 100;
        background: linear-gradient(135deg, #0f0c29 0%, #1a1a2e 100%);
      }
      .intro-screen.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }
      .intro-screen h1 {
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        color: #00ffff;
        padding: 0 1rem;
      }
      .iris-scan {
        width: 40px;
        height: 40px;
        border: 2px solid #00ffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .main-content {
        max-width: 600px;
        margin: 0 auto;
        padding: 1rem;
        display: none;
        padding-top: 100px;
      }

      /* Logo m√≥vil */
      .mobile-logo {
        display: none; /* Oculto por defecto */
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(15, 12, 41, 0.95);
        padding: 0.75rem 1rem;
        z-index: 45;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .mobile-logo.visible {
        opacity: 1;
      }

      .mobile-logo img {
        height: 40px;
        width: auto;
      }

      .mobile-user-btn {
        background: rgba(0, 255, 255, 0.2);
        border: 2px solid #00ffff;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }

      .mobile-user-btn:hover {
        background: rgba(0, 255, 255, 0.4);
        transform: scale(1.05);
      }

      /* Mostrar logo m√≥vil solo en m√≥vil */
      @media (max-width: 768px) {
        .mobile-logo {
          display: flex;
        }
        .main-content {
          padding-top: 70px; /* Espacio para el logo m√≥vil */
        }
      }

      .routine-title {
        text-align: center;
        margin-bottom: 2rem;
        font-size: 2rem;
        color: #00ffff;
      }
      .hidden {
        display: none !important;
      }
      .centered-button {
        display: flex;
        justify-content: center;
      }

      /* === ESTILOS DE PROGRESO === */
      .progress-title-main {
        font-family: "Phatt", sans-serif;
        font-size: 2rem;
        color: #00ffff;
        text-align: center;
        margin-bottom: 2rem;
        text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      }

      /* Tarjeta de racha principal */
      .streak-card {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        border-radius: 20px;
        padding: 1.75rem;
        text-align: center;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        position: relative;
      }

      .streak-icon {
        font-size: 3rem;
        margin-bottom: 0.5rem;
      }

      .streak-number {
        font-size: 3rem;
        font-weight: bold;
        line-height: 1;
        margin-bottom: 0.25rem;
      }

      .streak-label {
        font-size: 1.2rem;
        opacity: 0.95;
        font-weight: 500;
      }

      .streak-message {
        margin-top: 1rem;
        font-size: 1rem;
        font-weight: 500;
        opacity: 0.9;
      }

      /* Tarjetas de estad√≠sticas */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .stat-card {
        background: rgba(20, 20, 40, 0.8);
        border: 1.5px solid rgba(0, 255, 255, 0.25);
        border-radius: 14px;
        padding: 1.25rem 0.75rem;
        text-align: center;
      }

      .stat-icon {
        font-size: 1.75rem;
        margin-bottom: 0.4rem;
      }

      .stat-number {
        font-size: 1.75rem;
        font-weight: bold;
        color: #00ffff;
        line-height: 1;
        margin-bottom: 0.2rem;
      }

      .stat-label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.65);
      }

      /* Barra de progreso semanal */
      .progress-section {
        background: rgba(20, 20, 40, 0.8);
        border: 1.5px solid rgba(0, 255, 255, 0.25);
        border-radius: 14px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .progress-section-title {
        font-size: 1rem;
        color: #00ffff;
        margin-bottom: 0.75rem;
        font-weight: 600;
      }

      .progress-bar-container {
        width: 100%;
        height: 24px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        margin-bottom: 0.5rem;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #00ffff 0%, #00dddd 100%);
        border-radius: 12px;
        transition: width 0.5s ease;
        position: relative;
      }

      .progress-text {
        text-align: center;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.75);
      }

      /* Calendario mini */
      .calendar-preview {
        background: rgba(20, 20, 40, 0.8);
        border: 1.5px solid rgba(0, 255, 255, 0.25);
        border-radius: 14px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .calendar-preview-title {
        font-size: 1rem;
        color: #00ffff;
        margin-bottom: 0.75rem;
        font-weight: 600;
      }

      .week-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
      }

      .day-cell {
        aspect-ratio: 1;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
      }

      .day-cell.completed {
        background: linear-gradient(135deg, #00ff88 0%, #00ddaa 100%);
        border-color: #00ff88;
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
      }

      .day-cell.partial {
        background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
        border-color: #ffaa00;
      }

      .day-cell.today {
        border: 2px solid #00ffff;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      }

      .day-name {
        font-size: 0.65rem;
        opacity: 0.7;
        margin-bottom: 0.25rem;
      }

      /* Calendar Legend */
      .calendar-legend {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 255, 255, 0.2);
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
      }

      .legend-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1rem;
      }

      .completed-icon {
        background: linear-gradient(135deg, #00ff88 0%, #00ddaa 100%);
        color: #000;
        border: 1px solid #00ff88;
      }

      .partial-icon {
        background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
        color: #000;
        border: 1px solid #ffaa00;
      }

      .empty-icon {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      @media (max-width: 640px) {
        .calendar-legend {
          flex-wrap: wrap;
          gap: 0.75rem;
        }

        .legend-item {
          font-size: 0.75rem;
        }

        .legend-icon {
          width: 20px;
          height: 20px;
          font-size: 0.85rem;
        }
      }

      /* Loading state progreso */
      .progress-loading {
        text-align: center;
        padding: 2rem;
        color: #00ffff;
      }

      .progress-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 255, 255, 0.2);
        border-top-color: #00ffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      /* üîë ESTILOS DE BOTONES DE ACCI√ìN */
      .action-buttons-wrapper {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
      }

      .action-buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      #mark-completed {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-height: 44px;
      }

      #mark-completed:active {
        opacity: 0.9;
      }

      #mark-completed svg {
        flex-shrink: 0;
      }

      .secondary-action-btn {
        background: rgba(102, 126, 234, 0.15);
        color: #a78bfa;
        border: 1.5px solid rgba(167, 139, 250, 0.4);
        padding: 10px 16px;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-height: 44px;
        gap: 0.25rem;
      }

      .secondary-action-btn:active {
        background: rgba(102, 126, 234, 0.25);
      }

      /* === MODAL REGISTRO R√ÅPIDO === */
      .quick-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .quick-modal.hidden {
        display: none;
      }

      .quick-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.75);
      }

      .quick-modal-content {
        position: relative;
        background: linear-gradient(135deg, #1a1a2e 0%, #16162a 100%);
        border: 2px solid rgba(167, 139, 250, 0.4);
        border-radius: 20px;
        padding: 1.5rem;
        width: 100%;
        max-width: 360px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .quick-modal-close {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-size: 1.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .quick-modal-title {
        font-size: 1.25rem;
        color: #a78bfa;
        margin: 0 0 0.25rem 0;
        font-weight: 600;
      }

      .quick-modal-desc {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        margin: 0 0 1rem 0;
      }

      .quick-days-modal {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.35rem;
        margin-bottom: 1rem;
      }

      .quick-days-modal .quick-day-btn {
        padding: 0.4rem 0.2rem;
        min-width: auto;
        min-height: 48px;
        border-radius: 8px;
      }

      .quick-days-modal .quick-day-btn .day-name {
        font-size: 0.6rem;
      }

      .quick-days-modal .quick-day-btn .day-date {
        font-size: 0.9rem;
      }

      .quick-modal-form .form-input {
        margin-bottom: 0.75rem;
      }

      .checkbox-group-modal {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .checkbox-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem 0.75rem;
        background: linear-gradient(135deg, rgba(20, 20, 40, 0.9) 0%, rgba(30, 30, 50, 0.9) 100%);
        border: 1.5px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.85);
        -webkit-tap-highlight-color: transparent;
      }

      .checkbox-btn:active {
        background: rgba(0, 255, 255, 0.1);
      }

      .checkbox-btn:has(input:checked) {
        background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(0, 200, 200, 0.15) 100%);
        border-color: #00ffff;
        color: white;
      }

      .checkbox-btn input {
        display: none;
      }

      /* Estilos de la lista de productos en columna */
      .product-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding-bottom: 1rem;
      }

      /* ==================== TOAST NOTIFICATIONS (POP-UP MODAL) ==================== */
      .toast-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 999999;
        display: none;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }

      .toast-container.has-toast {
        display: flex;
        pointer-events: auto;
      }

      /* Overlay oscuro con blur */
      .toast-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        z-index: 1;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .toast-container {
          padding: 1rem;
        }
      }

      .toast {
        background: linear-gradient(
          135deg,
          rgba(20, 20, 40, 0.98) 0%,
          rgba(30, 30, 55, 0.98) 100%
        );
        border: 3px solid rgba(0, 255, 255, 0.7);
        border-radius: 20px;
        padding: 2rem 2.5rem;
        min-width: 320px;
        max-width: 500px;
        box-shadow:
          0 20px 60px rgba(0, 0, 0, 0.9),
          0 0 40px rgba(0, 255, 255, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
        /* Sin blur para mantener el texto n√≠tido */
        pointer-events: auto;
        animation: modalIn 200ms ease-out;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 0.75rem;
        position: relative;
        z-index: 2;
      }

      @keyframes modalIn {
        from {
          transform: translateY(8px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .toast.toast-exit {
        animation: modalOut 150ms ease-in forwards;
      }

      @keyframes modalOut {
        to {
          opacity: 0;
        }
      }

      @media (max-width: 768px) {
        .toast {
          min-width: unset;
          width: 90%;
          max-width: calc(100vw - 2rem);
          padding: 1.5rem 1.25rem;
        }
      }

      .toast-icon {
        font-size: 2.5rem;
        flex-shrink: 0;
        margin-bottom: 0.25rem;
      }

      .toast-content {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .toast-title {
        font-weight: 600;
        color: #00ffff;
        margin: 0;
        font-size: 1.2rem;
      }

      .toast-message {
        color: rgba(255, 255, 255, 0.9);
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.5;
        font-weight: 400;
      }

      .toast-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.5rem;
        line-height: 1;
        transition: all 0.3s ease;
      }

      .toast-close:hover {
        background: rgba(255, 68, 68, 0.3);
        border-color: rgba(255, 68, 68, 0.6);
        color: white;
        transform: rotate(90deg) scale(1.1);
      }

      /* Variantes de toast */
      .toast.success {
        border-color: rgba(0, 255, 136, 0.6);
        background: linear-gradient(
          135deg,
          rgba(0, 100, 50, 0.95) 0%,
          rgba(0, 150, 80, 0.95) 100%
        );
      }

      .toast.success::before {
        background: linear-gradient(90deg, #00ff88, #00ddaa);
      }

      .toast.success .toast-title {
        color: #00ff88;
        text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
      }

      .toast.warning {
        border-color: rgba(255, 170, 0, 0.6);
        background: linear-gradient(
          135deg,
          rgba(100, 70, 0, 0.95) 0%,
          rgba(150, 100, 0, 0.95) 100%
        );
      }

      .toast.warning::before {
        background: linear-gradient(90deg, #ffaa00, #ff8800);
      }

      .toast.warning .toast-title {
        color: #ffaa00;
        text-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
      }

      .toast.error {
        border-color: rgba(255, 70, 70, 0.6);
        background: linear-gradient(
          135deg,
          rgba(100, 20, 20, 0.95) 0%,
          rgba(150, 30, 30, 0.95) 100%
        );
      }

      .toast.error::before {
        background: linear-gradient(90deg, #ff4646, #ff3333);
      }

      .toast.error .toast-title {
        color: #ff4646;
        text-shadow: 0 0 10px rgba(255, 70, 70, 0.5);
      }

      @media (max-width: 640px) {
        .toast {
          min-width: auto;
          max-width: 100%;
          padding: 0.875rem 1rem;
        }

        .toast-icon {
          font-size: 1.5rem;
        }

        .toast-title {
          font-size: 0.9rem;
        }

        .toast-message {
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <AuthModal />

    <div id="intro-screen" class="intro-screen">
      <h1>Bienvenido a la gu√≠a de Skin Care</h1>
      <div class="iris-scan"></div>
    </div>

    <main id="main-content" class="main-content">
      <!-- Logo m√≥vil (solo visible en m√≥vil) -->
      <div class="mobile-logo">
        <img src="/images/logo.png" alt="Skincare Logo" />
        <button
          id="mobile-user-menu-btn"
          class="mobile-user-btn"
          title="Cuenta"
        >
          üë§
        </button>
      </div>

      <Header />

      <div id="guide-view">
        <h1 class="routine-title">{routineTitle}</h1>
        <div class="action-buttons-wrapper" style="margin-bottom:16px;">
          <div class="action-buttons">
            <button id="mark-completed" type="button">
              <svg
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="currentColor"
                style="margin-right: 0.5rem;"
              >
                <path
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                ></path>
              </svg>
              Completar Hoy
            </button>
            <button id="open-manual-register" type="button" class="secondary-action-btn" title="A√±adir d√≠a anterior">
              üìÖ A√±adir
            </button>
            <ReminderManager />
          </div>
        </div>

        <!-- MODAL REGISTRO R√ÅPIDO -->
        <div id="quick-register-modal" class="quick-modal hidden">
          <div class="quick-modal-overlay"></div>
          <div class="quick-modal-content">
            <button class="quick-modal-close" id="close-quick-modal">√ó</button>
            <h3 class="quick-modal-title">üìÖ Registrar D√≠a</h3>
            <p class="quick-modal-desc">A√±ade una rutina completada de d√≠as anteriores</p>
            
            <div id="quick-days-modal" class="quick-days-modal">
              <!-- Se llena con JavaScript -->
            </div>

            <div class="quick-modal-form">
              <input type="date" id="quick-modal-date" class="form-input" />
              
              <div class="checkbox-group-modal">
                <label class="checkbox-btn">
                  <input type="checkbox" id="quick-morning" value="morning">
                  <span>‚òÄÔ∏è Ma√±ana</span>
                </label>
                <label class="checkbox-btn">
                  <input type="checkbox" id="quick-night" value="night">
                  <span>üåô Noche</span>
                </label>
              </div>

              <button type="button" id="quick-submit-btn" class="submit-manual-btn">
                ‚úì Guardar
              </button>
            </div>
          </div>
        </div>

        <div class="product-list">
          {
            currentRoutine.map((product) => (
              <ProductCard
                step={product.step}
                title={product.title}
                accessCode={product.accessCode}
                function={product.function}
                usage={product.usage}
                image={product.image}
              />
            ))
          }
        </div>
      </div>

      <div id="calendar-view" class="hidden">
        <Calendar />
      </div>

      <div id="progress-view" class="hidden">
        <h1 class="progress-title-main">Tu Progreso</h1>

        <div id="progress-loading" class="progress-loading">
          <div class="progress-loading-spinner"></div>
          <p>Cargando estad√≠sticas...</p>
        </div>

        <div id="progress-content" style="display: none;">
          <!-- Tarjeta principal de racha -->
          <div class="streak-card">
            <div class="streak-icon">üî•</div>
            <div class="streak-number" id="streak-number">0</div>
            <div class="streak-label">d√≠as de racha</div>
            <div class="streak-message" id="streak-message">¬°Sigue as√≠!</div>
          </div>

          <!-- FORMULARIO REGISTRO MANUAL DE D√çAS -->
          <div class="manual-register-card">
            <div class="manual-register-header">
              <h3 class="manual-register-title">
                <span>üìù</span> Registrar D√≠a
              </h3>
              <button id="toggle-manual-form" class="manual-register-toggle">
                A√±adir
              </button>
            </div>
            
            <div id="manual-register-form" class="manual-register-form">
              <!-- Botones r√°pidos para d√≠as recientes -->
              <div class="quick-days" id="quick-days">
                <!-- Se llena con JavaScript -->
              </div>

              <form id="manual-completion-form">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" id="manual-date" class="form-input" required>
                  </div>
                </div>

                <div class="form-row">
                  <label class="form-label" style="width: 100%;">Rutinas completadas</label>
                </div>
                
                <div class="checkbox-group">
                  <label class="checkbox-item">
                    <input type="checkbox" name="routine-type" value="morning" id="check-morning">
                    <span class="checkbox-icon">‚òÄÔ∏è</span>
                    <span>Ma√±ana</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" name="routine-type" value="night" id="check-night">
                    <span class="checkbox-icon">üåô</span>
                    <span>Noche</span>
                  </label>
                </div>

                <button type="submit" class="submit-manual-btn" id="submit-manual">
                  <span>‚úì</span> Guardar Registro
                </button>
              </form>
            </div>
          </div>

          <!-- PANEL DE LOGROS Y DESAF√çOS -->
          <AchievementsPanel />

          <!-- Grid de estad√≠sticas -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üèÜ</div>
              <div class="stat-number" id="longest-streak">0</div>
              <div class="stat-label">R√©cord Personal</div>
            </div>

            <div class="stat-card">
              <div class="stat-icon">‚ú®</div>
              <div class="stat-number" id="total-completions">0</div>
              <div class="stat-label">Total Completadas</div>
            </div>

            <div class="stat-card">
              <div class="stat-icon">üìÖ</div>
              <div class="stat-number" id="days-active">0</div>
              <div class="stat-label">D√≠as Activos</div>
            </div>

            <div class="stat-card">
              <div class="stat-icon">üí™</div>
              <div class="stat-number" id="completion-rate">0%</div>
              <div class="stat-label">Tasa de √âxito</div>
            </div>
          </div>

          <!-- Progreso semanal -->
          <div class="progress-section">
            <div class="progress-section-title">Progreso esta semana</div>
            <div class="progress-bar-container">
              <div
                class="progress-bar-fill"
                id="progress-bar"
                style="width: 0%"
              >
              </div>
            </div>
            <div class="progress-text" id="progress-text">
              0 de 14 rutinas completadas
            </div>
          </div>

          <!-- Mini calendario de √∫ltima semana -->
          <div class="calendar-preview">
            <div class="calendar-preview-title">√öltimos 7 d√≠as</div>
            <div class="week-grid" id="week-calendar">
              <!-- Se llena din√°micamente -->
            </div>
            <div class="calendar-legend">
              <div class="legend-item">
                <span class="legend-icon completed-icon">‚úì</span>
                <span class="legend-text">Ambas rutinas</span>
              </div>
              <div class="legend-item">
                <span class="legend-icon partial-icon">¬Ω</span>
                <span class="legend-text">Una rutina</span>
              </div>
              <div class="legend-item">
                <span class="legend-icon empty-icon">‚óã</span>
                <span class="legend-text">Sin completar</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="routines-view" class="hidden">
        <RoutineEditor />
      </div>

      <div id="chat-view" class="hidden">
        <ChatWidget />
      </div>
    </main>

    <script is:inline>
      // PWA FIX 2: Registro manual del Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/sw.js")
          .then(() => {
            /* registro SW OK */
          })
          .catch((err) => {
            console.error("Error al registrar Service Worker:", err);
          });
      } // FIN DEL FIX PWA

      document.addEventListener("DOMContentLoaded", () => {
        const introScreen = document.getElementById("intro-screen");
        const mainContent = document.getElementById("main-content");
        const bottomNav = document.getElementById("bottom-nav");

        // Verificar si ya se mostr√≥ la intro en esta sesi√≥n
        const introShown = sessionStorage.getItem("introShown");

        if (introShown) {
          // Si ya se mostr√≥, saltarla inmediatamente
          introScreen.classList.add("hidden");
          mainContent.style.display = "block";
          if (bottomNav) {
            bottomNav.style.display = "flex";
            bottomNav.classList.add("visible");
          }
          const mobileLogo = document.querySelector(".mobile-logo");
          if (mobileLogo) {
            mobileLogo.classList.add("visible");
          }
        } else {
          // Primera vez, mostrar intro breve
          setTimeout(() => {
            introScreen.classList.add("hidden");
            mainContent.style.display = "block";
            if (bottomNav) {
              bottomNav.style.display = "flex";
              bottomNav.classList.add("visible");
            }
            const mobileLogo = document.querySelector(".mobile-logo");
            if (mobileLogo) {
              mobileLogo.classList.add("visible");
            }
            sessionStorage.setItem("introShown", "true");
          }, 1500); // Reducido de 3000ms a 1500ms
        }

        const navButtons = document.querySelectorAll(".main-nav .nav-link");
        const bottomNavButtons = document.querySelectorAll(
          "#bottom-nav .nav-item",
        );
        const guideView = document.getElementById("guide-view");
        const calendarView = document.getElementById("calendar-view");
        const progressView = document.getElementById("progress-view");
        const routinesView = document.getElementById("routines-view");
        const chatView = document.getElementById("chat-view");

        // Funci√≥n para activar una vista
        function activateView(viewName) {
          // Remover active de todos los botones
          navButtons.forEach((btn) => btn.classList.remove("active"));
          bottomNavButtons.forEach((btn) => btn.classList.remove("active"));

          // Ocultar todas las vistas
          guideView.classList.add("hidden");
          calendarView.classList.add("hidden");
          progressView.classList.add("hidden");
          routinesView.classList.add("hidden");
          chatView.classList.add("hidden");

          // Activar la vista correspondiente
          if (viewName === "guide") {
            guideView.classList.remove("hidden");
            document
              .querySelector('[data-view="guide"]')
              ?.classList.add("active");
          } else if (viewName === "calendar") {
            calendarView.classList.remove("hidden");
            document
              .querySelector('[data-view="calendar"]')
              ?.classList.add("active");
          } else if (viewName === "progress") {
            progressView.classList.remove("hidden");
            document
              .querySelector('[data-view="progress"]')
              ?.classList.add("active");
            // Cargar datos de progreso si no se han cargado
            if (window.loadProgressData) {
              window.loadProgressData();
            }
          } else if (viewName === "routines") {
            routinesView.classList.remove("hidden");
            document
              .querySelector('[data-view="routines"]')
              ?.classList.add("active");
          } else if (viewName === "chat") {
            chatView.classList.remove("hidden");
            document
              .querySelector('[data-view="chat"]')
              ?.classList.add("active");
          }
        }

        // Event listeners para botones del header
        navButtons.forEach((button) => {
          button.addEventListener("click", () => {
            activateView(button.getAttribute("data-view") || "guide");
          });
        });

        // Escuchar evento del bottom nav
        window.addEventListener("change-view", (e) => {
          activateView(e.detail);
        });

        // Bot√≥n de usuario m√≥vil
        const mobileUserBtn = document.getElementById("mobile-user-menu-btn");
        if (mobileUserBtn) {
          mobileUserBtn.addEventListener("click", () => {
            const authApi = window.authModal;
            const isAuth = !!(
              authApi &&
              typeof authApi.isAuthenticated === "function" &&
              authApi.isAuthenticated()
            );

            if (isAuth) {
              const logoutModal = document.getElementById("logout-modal");
              if (logoutModal) logoutModal.classList.remove("hidden");
            } else {
              const authModal = document.getElementById("auth-modal");
              if (authModal) authModal.classList.remove("hidden");
            }
          });
        }

        // Listener para actualizar progreso cuando se marca una rutina como completada
        window.addEventListener("routine-completed", () => {
          if (typeof window.loadProgressData === "function") {
            window.loadProgressData(true);
          }
        });
      });
    </script>

    <script>
      import {
        auth,
        getProgressData,
        onAuthStateChanged,
        type User,
      } from "../utils/firebase";

      // Funci√≥n para cargar datos de progreso
      let progressDataLoaded = false;

      async function loadProgressData(forceReload = false) {
        if (progressDataLoaded && !forceReload) return; // Ya se carg√≥, no volver a cargar

        // Resetear elementos si es recarga
        if (forceReload) {
          const loadingEl = document.getElementById("progress-loading");
          const contentEl = document.getElementById("progress-content");
          if (loadingEl) {
            loadingEl.style.display = "block";
            loadingEl.innerHTML =
              '<div class="progress-loading-spinner"></div><p>Cargando estad√≠sticas...</p>';
          }
          if (contentEl) contentEl.style.display = "none";
          progressDataLoaded = false;
        }

        onAuthStateChanged(auth, async (user: User | null) => {
          if (!user) {
            const loadingEl = document.getElementById("progress-loading");
            if (loadingEl) {
              loadingEl.innerHTML = `
                  <p style="margin-bottom: 1rem;">üîí Inicia sesi√≥n para ver tu progreso</p>
                  <button 
                    onclick="window.dispatchEvent(new CustomEvent('open-auth-modal'))"
                    style="
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      border: none;
                      padding: 1rem 2rem;
                      border-radius: 12px;
                      font-size: 1rem;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.3s ease;
                    "
                  >
                    Iniciar Sesi√≥n
                  </button>
                `;
            }
            return;
          }

          try {
            const progressData = await getProgressData();

            if (!progressData) {
              const loadingEl = document.getElementById("progress-loading");
              if (loadingEl) {
                loadingEl.innerHTML = `<p>Error cargando datos. Intenta de nuevo.</p>`;
              }
              return;
            }

            // Guardar progreso para los logros
            (window as any).currentProgressData = progressData;

            progressDataLoaded = true;

            // Ocultar loading y mostrar contenido
            const loadingEl = document.getElementById("progress-loading");
            const contentEl = document.getElementById("progress-content");
            if (loadingEl) loadingEl.style.display = "none";
            if (contentEl) contentEl.style.display = "block";

            // Actualizar racha actual
            const streakNumber = document.getElementById("streak-number");
            if (streakNumber) {
              streakNumber.textContent = String(progressData.currentStreak);
            }

            // Mensaje motivacional seg√∫n racha
            const streakMessage = document.getElementById("streak-message");
            if (streakMessage) {
              if (progressData.currentStreak === 0) {
                streakMessage.textContent = "¬°Comienza tu racha hoy!";
              } else if (progressData.currentStreak < 3) {
                streakMessage.textContent = "¬°Buen comienzo! üí™";
              } else if (progressData.currentStreak < 7) {
                streakMessage.textContent = "¬°Vas muy bien! üåü";
              } else if (progressData.currentStreak < 30) {
                streakMessage.textContent = "¬°Incre√≠ble constancia! üöÄ";
              } else {
                streakMessage.textContent = "¬°Eres una leyenda! üëë";
              }
            }

            // Actualizar r√©cord personal
            const longestStreakEl = document.getElementById("longest-streak");
            if (longestStreakEl) {
              longestStreakEl.textContent = String(progressData.longestStreak);
            }

            // Total completadas
            const totalCompletionsEl =
              document.getElementById("total-completions");
            if (totalCompletionsEl) {
              totalCompletionsEl.textContent = String(
                progressData.totalCompletions,
              );
            }

            // D√≠as activos
            const daysActive = Object.keys(progressData.completions).length;
            const daysActiveEl = document.getElementById("days-active");
            if (daysActiveEl) {
              daysActiveEl.textContent = String(daysActive);
            }

            // Tasa de √©xito
            const possibleCompletions = daysActive * 2;
            const completionRate =
              possibleCompletions > 0
                ? Math.round(
                    (progressData.totalCompletions / possibleCompletions) * 100,
                  )
                : 0;
            const completionRateEl = document.getElementById("completion-rate");
            if (completionRateEl) {
              completionRateEl.textContent = `${completionRate}%`;
            }

            // Progreso semanal (√∫ltimos 7 d√≠as)
            const today = new Date();
            if (today.getHours() < 6) {
              today.setDate(today.getDate() - 1);
            }
            const last7Days = [];
            let weekCompletions = 0;

            for (let i = 6; i >= 0; i--) {
              const date = new Date(today);
              date.setDate(date.getDate() - i);
              const dateStr = date.toLocaleDateString("en-CA"); // YYYY-MM-DD local
              last7Days.push({
                date: dateStr,
                data: progressData.completions[dateStr],
              });

              const dayData = progressData.completions[dateStr];
              if (dayData) {
                if (dayData.morning?.completed) weekCompletions++;
                if (dayData.night?.completed) weekCompletions++;
              }
            }

            const weekPercentage = (weekCompletions / 14) * 100;
            const progressBarEl = document.getElementById("progress-bar");
            if (progressBarEl) {
              progressBarEl.style.width = `${weekPercentage}%`;
            }
            const progressTextEl = document.getElementById("progress-text");
            if (progressTextEl) {
              progressTextEl.textContent = `${weekCompletions} de 14 rutinas completadas`;
            }

            // Mini calendario de √∫ltima semana
            const weekCalendar = document.getElementById("week-calendar");
            const dayNames = ["D", "L", "M", "X", "J", "V", "S"];

            /* datos calendario cargados */

            if (weekCalendar) {
              weekCalendar.innerHTML = ""; // Limpiar antes de llenar
              last7Days.forEach((day, index) => {
                const cell = document.createElement("div");
                cell.className = "day-cell";

                const dayData = day.data;
                const morningDone = dayData?.morning?.completed;
                const nightDone = dayData?.night?.completed;

                /* d√≠a procesado */

                if (morningDone && nightDone) {
                  cell.classList.add("completed");
                  cell.innerHTML = `<span class="day-name" style="margin-bottom: 0.5rem;">${dayNames[new Date(day.date).getDay()]}</span><span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">‚úì</span>`;
                } else if (morningDone || nightDone) {
                  cell.classList.add("partial");
                  cell.innerHTML = `<span class="day-name" style="margin-bottom: 0.5rem;">${dayNames[new Date(day.date).getDay()]}</span><span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: 0.9rem; font-weight: bold; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">¬Ω</span>`;
                } else {
                  cell.innerHTML = `<span class="day-name" style="margin-bottom: 0.5rem;">${dayNames[new Date(day.date).getDay()]}</span><span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: rgba(255,255,255,0.7); font-size: 0.9rem; box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);">‚óã</span>`;
                }

                if (index === 6) {
                  cell.classList.add("today");
                }

                weekCalendar.appendChild(cell);
              });
            }

            // Disparar evento para actualizar logros
            window.dispatchEvent(new CustomEvent("progress-updated"));
          } catch (error) {
            console.error("Error cargando progreso:", error);
            const loadingEl = document.getElementById("progress-loading");
            if (loadingEl) {
              loadingEl.innerHTML = `<p>Error cargando datos. Intenta de nuevo.</p>`;
            }
          }
        });
      }

      // Hacer la funci√≥n disponible globalmente
      (window as any).loadProgressData = loadProgressData;

      // ==================== FUNCIONES DE RUTINA ====================
      import {
        markRoutineComplete,
        isRoutineCompleted,
        registerManualCompletion,
      } from "../utils/firebase";

      // ==================== REGISTRO MANUAL DE D√çAS ====================
      
      function initManualRegistration() {
        const toggleBtn = document.getElementById('toggle-manual-form');
        const formContainer = document.getElementById('manual-register-form');
        const form = document.getElementById('manual-completion-form') as HTMLFormElement;
        const dateInput = document.getElementById('manual-date') as HTMLInputElement;
        const quickDaysContainer = document.getElementById('quick-days');

        if (!toggleBtn || !formContainer || !form) return;

        // Toggle del formulario
        toggleBtn.addEventListener('click', () => {
          formContainer.classList.toggle('visible');
          toggleBtn.textContent = formContainer.classList.contains('visible') ? 'Cerrar' : 'A√±adir';
        });

        // Establecer fecha m√°xima como hoy
        const today = new Date();
        const todayStr = today.toLocaleDateString('en-CA');
        dateInput.max = todayStr;
        dateInput.value = todayStr;

        // Generar botones r√°pidos para los √∫ltimos 7 d√≠as
        if (quickDaysContainer) {
          const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
          quickDaysContainer.innerHTML = '';
          
          for (let i = 0; i < 7; i++) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toLocaleDateString('en-CA');
            const dayName = i === 0 ? 'Hoy' : i === 1 ? 'Ayer' : dayNames[date.getDay()];
            const dayNum = date.getDate();

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'quick-day-btn' + (i === 0 ? ' selected' : '');
            btn.innerHTML = `<span class="day-name">${dayName}</span><span class="day-date">${dayNum}</span>`;
            btn.addEventListener('click', () => {
              dateInput.value = dateStr;
              document.querySelectorAll('.quick-day-btn').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
            });
            quickDaysContainer.appendChild(btn);
          }
        }

        // Manejar env√≠o del formulario - optimizado
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const date = dateInput.value;
          const morningChecked = (document.getElementById('check-morning') as HTMLInputElement)?.checked;
          const nightChecked = (document.getElementById('check-night') as HTMLInputElement)?.checked;

          if (!date) {
            showToast('Selecciona una fecha', { type: 'warning', icon: 'üìÖ', duration: 2500 });
            return;
          }

          if (!morningChecked && !nightChecked) {
            showToast('Selecciona al menos una rutina', { type: 'warning', icon: '‚ö†Ô∏è', duration: 2500 });
            return;
          }

          const routineTypes: ('morning' | 'night')[] = [];
          if (morningChecked) routineTypes.push('morning');
          if (nightChecked) routineTypes.push('night');

          const submitBtn = document.getElementById('submit-manual') as HTMLButtonElement;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span>‚è≥</span> Guardando...';

          // Cerrar formulario inmediatamente para UX r√°pida
          formContainer.classList.remove('visible');
          toggleBtn.textContent = 'A√±adir';

          try {
            await registerManualCompletion(date, routineTypes);
            
            showToast('¬°Guardado!', { 
              type: 'success', 
              icon: '‚úÖ',
              title: 'D√≠a registrado',
              duration: 2500
            });

            // Resetear formulario
            (document.getElementById('check-morning') as HTMLInputElement).checked = false;
            (document.getElementById('check-night') as HTMLInputElement).checked = false;

            // Actualizar datos de progreso en segundo plano
            requestAnimationFrame(() => {
              if (typeof (window as any).loadProgressData === 'function') {
                (window as any).loadProgressData(true);
              }
            });

          } catch (error: any) {
            showToast(error.message || 'Error al guardar', { type: 'error', icon: '‚ùå' });
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>‚úì</span> Guardar Registro';
          }
        });
      }

      // ==================== MODAL REGISTRO R√ÅPIDO (PANTALLA PRINCIPAL) ====================
      
      function initQuickRegisterModal() {
        const openBtn = document.getElementById('open-manual-register');
        const modal = document.getElementById('quick-register-modal');
        const closeBtn = document.getElementById('close-quick-modal');
        const overlay = modal?.querySelector('.quick-modal-overlay');
        const dateInput = document.getElementById('quick-modal-date') as HTMLInputElement;
        const quickDaysContainer = document.getElementById('quick-days-modal');
        const submitBtn = document.getElementById('quick-submit-btn');

        if (!openBtn || !modal || !closeBtn || !dateInput) return;

        // Configurar fecha m√°xima como hoy
        const today = new Date();
        const todayStr = today.toLocaleDateString('en-CA');
        dateInput.max = todayStr;
        
        // Por defecto, seleccionar ayer
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        dateInput.value = yesterday.toLocaleDateString('en-CA');

        // Generar botones r√°pidos
        if (quickDaysContainer) {
          const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
          quickDaysContainer.innerHTML = '';
          
          for (let i = 1; i <= 7; i++) { // Empezamos desde ayer
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toLocaleDateString('en-CA');
            const dayName = i === 1 ? 'Ayer' : dayNames[date.getDay()];
            const dayNum = date.getDate();

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'quick-day-btn' + (i === 1 ? ' selected' : '');
            btn.innerHTML = `<span class="day-name">${dayName}</span><span class="day-date">${dayNum}</span>`;
            btn.addEventListener('click', () => {
              dateInput.value = dateStr;
              quickDaysContainer.querySelectorAll('.quick-day-btn').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
            });
            quickDaysContainer.appendChild(btn);
          }
        }

        // Abrir modal
        openBtn.addEventListener('click', () => {
          modal.classList.remove('hidden');
        });

        // Cerrar modal
        const closeModal = () => modal.classList.add('hidden');
        closeBtn.addEventListener('click', closeModal);
        overlay?.addEventListener('click', closeModal);

        // Enviar formulario - optimizado para no bloquear UI
        submitBtn?.addEventListener('click', async () => {
          const date = dateInput.value;
          const morningChecked = (document.getElementById('quick-morning') as HTMLInputElement)?.checked;
          const nightChecked = (document.getElementById('quick-night') as HTMLInputElement)?.checked;

          if (!date) {
            showToast('Selecciona una fecha', { type: 'warning', icon: 'üìÖ', duration: 2500 });
            return;
          }

          if (!morningChecked && !nightChecked) {
            showToast('Selecciona al menos una rutina', { type: 'warning', icon: '‚ö†Ô∏è', duration: 2500 });
            return;
          }

          const routineTypes: ('morning' | 'night')[] = [];
          if (morningChecked) routineTypes.push('morning');
          if (nightChecked) routineTypes.push('night');

          const btn = submitBtn as HTMLButtonElement;
          btn.disabled = true;
          btn.textContent = '‚è≥ Guardando...';

          // Cerrar modal inmediatamente para feedback r√°pido
          closeModal();

          try {
            await registerManualCompletion(date, routineTypes);
            
            showToast('¬°D√≠a registrado!', { 
              type: 'success', 
              icon: '‚úÖ',
              title: 'Guardado',
              duration: 2500
            });

            // Resetear checkboxes
            (document.getElementById('quick-morning') as HTMLInputElement).checked = false;
            (document.getElementById('quick-night') as HTMLInputElement).checked = false;

            // Actualizar progreso en segundo plano
            requestAnimationFrame(() => {
              if (typeof (window as any).loadProgressData === 'function') {
                (window as any).loadProgressData(true);
              }
            });

          } catch (error: any) {
            showToast(error.message || 'Error al guardar', { type: 'error', icon: '‚ùå' });
          } finally {
            btn.disabled = false;
            btn.textContent = '‚úì Guardar';
          }
        });
      }

      // Inicializar registro manual cuando el DOM est√© listo
      document.addEventListener('DOMContentLoaded', () => {
        // Usar requestIdleCallback si est√° disponible para no bloquear renderizado
        const initFn = () => {
          initManualRegistration();
          initQuickRegisterModal();
        };
        
        if ('requestIdleCallback' in window) {
          (window as any).requestIdleCallback(initFn, { timeout: 1000 });
        } else {
          setTimeout(initFn, 300);
        }
      });

      // ==================== SISTEMA DE NOTIFICACIONES MEJORADO ====================

      interface ToastOptions {
        type?: "success" | "warning" | "error" | "info";
        title?: string;
        icon?: string;
        duration?: number;
      }

      function showToast(message: string, options: ToastOptions = {}) {
        const {
          type = "info",
          title = type === "success"
            ? "¬°√âxito!"
            : type === "warning"
              ? "Atenci√≥n"
              : type === "error"
                ? "Error"
                : "Info",
          icon = type === "success"
            ? "üéâ"
            : type === "warning"
              ? "‚ö†Ô∏è"
              : type === "error"
                ? "‚ùå"
                : "‚ÑπÔ∏è",
          duration = 5000,
        } = options;

        const container = document.getElementById("toast-container");
        if (!container) return;

        // Limpiar toasts anteriores
        container.innerHTML = "";

        // A√±adir clase para mostrar overlay
        container.classList.add("has-toast");

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        toast.innerHTML = `
          <button class="toast-close" aria-label="Cerrar">√ó</button>
          <div class="toast-icon">${icon}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
          </div>
        `;

        container.appendChild(toast);

        // Bot√≥n cerrar
        const closeBtn = toast.querySelector(".toast-close");
        closeBtn?.addEventListener("click", () =>
          removeToast(toast, container),
        );

        // Click en overlay para cerrar
        container.addEventListener("click", (e) => {
          if (e.target === container) {
            removeToast(toast, container);
          }
        });

        // Auto-remove
        const timeout = setTimeout(
          () => removeToast(toast, container),
          duration,
        );

        // Limpiar timeout si se cierra manualmente
        toast.setAttribute("data-timeout", String(timeout));
      }

      function removeToast(toast: HTMLElement, container: HTMLElement) {
        const timeoutId = toast.getAttribute("data-timeout");
        if (timeoutId) clearTimeout(Number(timeoutId));

        toast.classList.add("toast-exit");

        setTimeout(() => {
          toast.remove();
          // Quitar overlay si no hay m√°s toasts
          if (container.children.length === 0) {
            container.classList.remove("has-toast");
          }
        }, 300);
      }

      // Hacer disponible globalmente
      (window as any).showToast = showToast;

      // Funci√≥n para marcar rutina como completada
      async function markRoutineCompleted(routineType: string) {
        try {
          // Verificar autenticaci√≥n
          const user = await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(
              auth,
              (user: User | null) => {
                unsubscribe();
                resolve(user);
              },
            );
          });

          if (!user) {
            window.dispatchEvent(new CustomEvent("open-auth-modal"));
            return;
          }

          // Funci√≥n para obtener fecha ajustada (si es antes de las 6 AM, cuenta como ayer)
          const getAdjustedDate = () => {
            const now = new Date();
            if (now.getHours() < 6) {
              now.setDate(now.getDate() - 1);
            }
            return now.toLocaleDateString("en-CA"); // YYYY-MM-DD local
          };

          const todayKey = getAdjustedDate();
          const firestoreRoutineType =
            routineType === "diurno" ? "morning" : "night";

          await markRoutineComplete(todayKey, firestoreRoutineType);

          // Actualizar UI con estilo de √©xito
          const btnComplete = document.getElementById("mark-completed");
          if (btnComplete) {
            btnComplete.setAttribute("disabled", "true");
            btnComplete.innerHTML = "‚úÖ ¬°Completado!";
            (btnComplete as HTMLButtonElement).style.background = "linear-gradient(135deg, #10b981 0%, #059669 100%)";
            (btnComplete as HTMLButtonElement).style.cursor = "default";
          }

          // Disparar evento para actualizar progreso
          window.dispatchEvent(new CustomEvent("routine-completed"));

          // Sin toast: solo actualizar bot√≥n y estado
        } catch (error) {
          // Error silencioso (sin toast)
        }
      }

      // Funci√≥n para verificar si ya est√° completada hoy
      async function checkTodayCompletion() {
        try {
          // Verificar autenticaci√≥n
          const user = await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(
              auth,
              (user: User | null) => {
                unsubscribe();
                resolve(user);
              },
            );
          });

          const btnComplete = document.getElementById("mark-completed");

          if (!user) {
            // No autenticado, mostrar modal al hacer clic (sin toast)
            btnComplete?.addEventListener("click", () => {
              window.dispatchEvent(new CustomEvent("open-auth-modal"));
            });
            return;
          }

          // Funci√≥n para obtener fecha ajustada (si es antes de las 6 AM, cuenta como ayer)
          const getAdjustedDate = () => {
            const now = new Date();
            if (now.getHours() < 6) {
              now.setDate(now.getDate() - 1);
            }
            return now.toLocaleDateString("en-CA"); // YYYY-MM-DD local
          };

          const todayKey = getAdjustedDate();
          const currentRoutine = (window as any).currentRoutine || "diurno";
          const firestoreRoutineType =
            currentRoutine === "diurno" ? "morning" : "night";

          const alreadyDone = await isRoutineCompleted(
            todayKey,
            firestoreRoutineType,
          );

          if (alreadyDone && btnComplete) {
            btnComplete.setAttribute("disabled", "true");
            btnComplete.innerHTML = "‚úÖ ¬°Completado!";
            (btnComplete as HTMLButtonElement).style.background = "linear-gradient(135deg, #10b981 0%, #059669 100%)";
            (btnComplete as HTMLButtonElement).style.cursor = "default";
          }
        } catch (error) {
          console.error("Error verificando completado:", error);
        }
      }

      // Hacer funciones disponibles globalmente
      (window as any).markRoutineCompleted = markRoutineCompleted;
      (window as any).checkTodayCompletion = checkTodayCompletion;
    </script>

    <script is:inline>
      // nombre de la clave en localStorage
      const REMINDERS_KEY = "skincareReminders_v1";
      const sessionTimers = {}; // timeouts en memoria (no se serializan)

      // Helpers de storage
      function loadReminders() {
        try {
          return JSON.parse(localStorage.getItem(REMINDERS_KEY) || "[]");
        } catch (e) {
          console.error("Error parseando recordatorios", e);
          return [];
        }
      }
      function saveReminders(list) {
        localStorage.setItem(REMINDERS_KEY, JSON.stringify(list));
      }

      // Asegura registro de service worker (si existe)
      async function ensureSWReady() {
        if (!("serviceWorker" in navigator)) return null;
        try {
          return await navigator.serviceWorker.ready;
        } catch (e) {
          console.warn("Service Worker no listo", e);
          return null;
        }
      }

      // Pedir permiso de notificaciones si hace falta
      function requestNotificationPermission() {
        if (!("Notification" in window)) return Promise.resolve("denied");
        if (Notification.permission === "granted")
          return Promise.resolve("granted");
        if (Notification.permission === "denied")
          return Promise.resolve("denied");
        return Notification.requestPermission();
      }

      // Enviar notificaci√≥n (intenta service worker, si no Notification())
      async function showNotification(title, body, data = {}) {
        if (!("Notification" in window)) {
          if (typeof window.showToast === "function") {
            window.showToast(body || title, { type: "info", icon: "üîî" });
          }
          return;
        }

        const permission = Notification.permission;
        if (permission !== "granted") {
          if (typeof window.showToast === "function") {
            window.showToast(body || title, { type: "info", icon: "üîî" });
          }
          return;
        }

        const reg = await ensureSWReady();
        const options = {
          body: body,
          tag: "skincare-reminder",
          renotify: false,
          data,
          // Ajusta iconos seg√∫n tu PWA (a√±ade los archivos)
          icon: "/icons/icon-192.png",
          badge: "/icons/icon-72.png",
        };

        try {
          if (reg && typeof reg.showNotification === "function") {
            // Mostramos desde el SW cuando sea posible
            reg.showNotification(title, options);
          } else {
            new Notification(title, options);
          }
        } catch (e) {
          console.warn(
            "No se pudo mostrar notificaci√≥n via SW, fallback a Notification",
            e,
          );
          try {
            new Notification(title, options);
          } catch (err) {
            if (typeof window.showToast === "function") {
              window.showToast(body || title, { type: "info", icon: "üîî" });
            }
          }
        }
      }

      // Disparar recordatorio (mark fired + notificaci√≥n)
      async function fireReminder(reminder) {
        // Marca como fired
        const list = loadReminders();
        const idx = list.findIndex((r) => r.id === reminder.id);
        if (idx !== -1) {
          list[idx].fired = true;
          saveReminders(list);
        }
        if (sessionTimers[reminder.id]) {
          clearTimeout(sessionTimers[reminder.id]);
          delete sessionTimers[reminder.id];
        }

        const title = `Recordatorio Skincare`;
        const body = `Es hora de tu rutina: ${reminder.title || "Rutina"}`;
        await showNotification(title, body, { id: reminder.id });
        renderReminders();
      }

      // Programar timeout en memoria (si queda tiempo)
      function scheduleReminder(reminder) {
        const remaining = reminder.when - Date.now();
        if (remaining <= 0) {
          // si ya pas√≥: disparar inmediatamente
          fireReminder(reminder);
          return;
        }
        const tid = setTimeout(() => fireReminder(reminder), remaining);
        sessionTimers[reminder.id] = tid;
      }

      // A√±adir recordatorio en X minutos
      function addReminderIn(minutes) {
        const titleElement = document.querySelector(".routine-title");
        const title = titleElement ? titleElement.textContent.trim() : "Rutina";
        const when = Date.now() + minutes * 60 * 1000;
        const reminder = {
          id: "r-" + Date.now(),
          when,
          minutes,
          title,
          fired: false,
        };

        const list = loadReminders();
        list.push(reminder);
        saveReminders(list);
        scheduleReminder(reminder);

        // Pedimos permiso (si el usuario acepta, la notificaci√≥n saldr√°)
        requestNotificationPermission().then((perm) => {
          if (perm !== "granted") {
            if (typeof window.showToast === "function") {
              window.showToast(
                "Activa las notificaciones para recibir recordatorios",
                {
                  type: "warning",
                  icon: "üîî",
                },
              );
            }
          } else {
            if (typeof window.showToast === "function") {
              window.showToast("Recordatorio programado correctamente", {
                type: "success",
                icon: "‚è∞",
              });
            }
          }
        });

        renderReminders();
      }

      // Cancelar recordatorio
      function cancelReminder(id) {
        let list = loadReminders();
        list = list.filter((r) => r.id !== id);
        saveReminders(list);
        if (sessionTimers[id]) {
          clearTimeout(sessionTimers[id]);
          delete sessionTimers[id];
        }
        renderReminders();
      }

      // Render lista de recordatorios (simple)
      function renderReminders() {
        const container = document.getElementById("reminders-list");
        if (!container) return;
        const list = loadReminders().sort((a, b) => a.when - b.when);
        container.innerHTML = "";
        if (list.length === 0) {
          container.innerHTML =
            "<div style='opacity:0.5;color:#0ff;text-align:center'>No hay recordatorios activos</div>";
          return;
        }
        list.forEach((r) => {
          const div = document.createElement("div");
          div.className = "reminder-row";
          div.style =
            "display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-radius:8px;background:rgba(0,255,255,0.05);margin-bottom:8px;backdrop-filter:blur(4px);";

          const left = document.createElement("div");
          left.innerHTML = `<strong style="display:block;color:#0ff">${new Date(
            r.when,
          ).toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
          })}</strong><small style="opacity:0.7;color:#ccc">${r.title}</small>`;

          const right = document.createElement("div");
          right.style = "display:flex;align-items:center;gap:6px";

          // ‚úÖ Mostrar check si ya se dispar√≥
          if (r.fired) {
            const span = document.createElement("span");
            span.textContent = "enviado";
            span.style.color = "#0ff";
            span.style.fontSize = "0.85rem";
            span.style.opacity = "0.7";
            right.appendChild(span);
          }

          // ‚ùå Bot√≥n de eliminar siempre disponible
          const btnCancel = document.createElement("button");
          btnCancel.innerHTML = "‚ùå";
          btnCancel.style =
            "padding:4px 8px;border-radius:6px;border:none;cursor:pointer;background:rgba(255,0,255,0.1);color:#ff5555;font-size:0.9rem;transition:0.2s;backdrop-filter:blur(2px)";
          btnCancel.title = "Eliminar recordatorio";
          btnCancel.addEventListener("mouseenter", () => {
            btnCancel.style.background = "rgba(255,0,255,0.3)";
            btnCancel.style.boxShadow = "0 0 6px #ff00ff";
          });
          btnCancel.addEventListener("mouseleave", () => {
            btnCancel.style.background = "rgba(255,0,255,0.1)";
            btnCancel.style.boxShadow = "none";
          });
          btnCancel.addEventListener("click", () => cancelReminder(r.id));
          right.appendChild(btnCancel);

          div.appendChild(left);
          div.appendChild(right);
          container.appendChild(div);
        });
      }

      // Inicializa: restaurar timers de localStorage
      function initReminders() {
        const list = loadReminders();
        list.forEach((r) => {
          if (!r.fired && r.when > Date.now()) scheduleReminder(r);
          else if (!r.fired && r.when <= Date.now()) {
            // algo qued√≥ pendiente, lo disparamos al iniciar
            fireReminder(r);
          }
        });
        renderReminders();
      }

      // Wire UI (botones)
      document.addEventListener("DOMContentLoaded", () => {
        const btn10 = document.getElementById("rem-10");
        const btn30 = document.getElementById("rem-30");
        const btn60 = document.getElementById("rem-60");
        const form = document.getElementById("rem-custom-form");

        if (btn10) btn10.addEventListener("click", () => addReminderIn(10));
        if (btn30) btn30.addEventListener("click", () => addReminderIn(30));
        if (btn60) btn60.addEventListener("click", () => addReminderIn(60));
        if (form) {
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            const minutes = parseInt(form.elements["minutes"].value, 10);
            if (!minutes || minutes <= 0) {
              if (typeof window.showToast === "function") {
                window.showToast("Introduce un n√∫mero v√°lido de minutos", {
                  type: "warning",
                  icon: "‚ö†Ô∏è",
                });
              }
              return;
            }
            addReminderIn(minutes);
            form.reset();
          });
        }

        initReminders();

        // ==================== SEGUIMIENTO DE RUTINAS CON FIREBASE ====================

        // Usar las funciones globales del script de m√≥dulo
        // Determinar tipo de rutina basado en la hora
        const now = new Date();
        const madridHour = new Date(
          now.toLocaleString("en-US", { timeZone: "Europe/Madrid" }),
        ).getHours();
        const isDayTimeClient = madridHour >= 6 && madridHour < 20;
        const routineType = isDayTimeClient ? "diurno" : "nocturno";

        // Guardar en window para que checkTodayCompletion lo pueda usar
        window.currentRoutine = routineType;

        // Bot√≥n marcar como completada
        const btnComplete = document.getElementById("mark-completed");

        // Configurar listener del bot√≥n
        btnComplete?.addEventListener("click", () => {
          if (!btnComplete.disabled && window.markRoutineCompleted) {
            window.markRoutineCompleted(routineType);
          }
        });

        // Verificar si ya est√° completada hoy
        if (window.checkTodayCompletion) {
          window.checkTodayCompletion();
        }

        // Exponer para debugging
        window.skincareReminders = {
          addReminderIn,
          loadReminders,
          cancelReminder,
        };
      });

      // üîÑ Recargar la lista de productos din√°micamente desde Firebase
      async function reloadProductList() {
        try {
          const { getRoutines } = await import("./src/utils/firebase.ts");
          const routineData = await getRoutines();
          if (!routineData) return;

          // Determinar si es de d√≠a o noche (hora Madrid)
          const now = new Date();
          const madridHour = new Date(
            now.toLocaleString("en-US", { timeZone: "Europe/Madrid" }),
          ).getHours();
          const isDayTime = madridHour >= 6 && madridHour < 20;

          // D√≠a de la semana en Madrid
          const dayOfWeek = new Intl.DateTimeFormat("es-ES", {
            timeZone: "Europe/Madrid",
            weekday: "long",
          }).format(now);
          const capitalizedDay =
            dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1);

          let products = [];
          if (isDayTime) {
            products = routineData.dailyRoutine
              .filter((p) => p.enabled)
              .sort((a, b) => a.step - b.step);
          } else {
            products = (routineData.nightlyRoutines[capitalizedDay] || [])
              .filter((p) => p.enabled)
              .sort((a, b) => a.step - b.step);
          }

          // Renderizar productos
          const productList = document.querySelector(".product-list");
          if (productList && products.length > 0) {
            productList.innerHTML = products
              .map(
                (product) => `
              <div class="product-card" style="background-color: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 1rem; padding: 1.5rem; margin: 1rem 0; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: row; align-items: center; gap: 1.5rem; position: relative;">
                <div class="step-badge" style="position: absolute; top: -10px; left: -10px; background-color: #00ffff; color: black; border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2rem;">${product.step}</div>
                <img src="${product.image}" alt="${product.accessCode}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid #00ffff;" />
                <div style="flex-grow: 1;">
                  <h2 style="font-family: 'Phatt', sans-serif; font-size: 1.5rem; margin: 0; letter-spacing: 0.09em;">${product.title}</h2>
                  <h3 style="font-size: 1rem; font-style: italic; opacity: 0.7; margin: 0.5rem 0;">C√≥digo de Acceso: ${product.accessCode}</h3>
                  <p style="font-size: 1rem; line-height: 1.4; margin: 0.5rem 0; opacity: 0.9;"><strong>Funci√≥n:</strong> ${product.function}</p>
                  <p style="font-size: 1rem; line-height: 1.4; margin: 0.5rem 0; opacity: 0.9;"><strong>Modo de Empleo:</strong> ${product.usage}</p>
                </div>
              </div>
            `,
              )
              .join("");
          }
        } catch (error) {
          console.error("Error recargando productos:", error);
        }
      }

      // Detectar cambios en rutinas y recargar autom√°ticamente
      window.addEventListener("routines-updated", async function () {
        /* rutinas actualizadas detectadas */
        await reloadProductList();

        // Mostrar notificaci√≥n
        const toast = document.createElement("div");
        toast.style.cssText =
          "position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#00ffff;color:#000;padding:12px 24px;border-radius:8px;z-index:9999;font-weight:bold;box-shadow:0 4px 12px rgba(0,255,255,0.5);";
        toast.textContent = "‚úÖ Rutinas actualizadas";
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      });
    </script>

    <script>
      // ==================== NUEVO SISTEMA DE RECORDATORIOS Y LOGROS ====================
      import {
        initReminders,
        addReminder,
        deleteReminder,
        snoozeReminder,
        loadReminders,
        requestNotificationPermission,
        createReminder,
        getTimeUntil,
        formatReminderTime,
      } from "../utils/reminders";
      import {
        ACHIEVEMENTS,
        getCurrentChallenge,
        checkNewAchievements,
        getUnlockedAchievements,
        type UserStats,
      } from "../data/achievements";

      // ==================== RECORDATORIOS ====================

      function renderReminders() {
        const container = document.getElementById("active-reminders");
        if (!container) return;

        const reminders = loadReminders();
        const activeReminders = reminders.filter(
          (r) => !r.fired && r.when > Date.now(),
        );

        if (activeReminders.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 2rem; opacity: 0.6;">
              <p style="color: #a78bfa;">No hay recordatorios activos</p>
              <p style="font-size: 0.875rem; color: #9ca3af;">Programa uno para no olvidar tu rutina</p>
            </div>
          `;
          return;
        }

        container.innerHTML = activeReminders
          .map(
            (reminder) => `
          <div class="reminder-item">
            <div class="reminder-info">
              <h4 class="reminder-title">${reminder.title}</h4>
              <p class="reminder-time">
                ‚è∞ ${formatReminderTime(reminder.when)}
                <span style="opacity: 0.7; margin-left: 0.5rem;">(${getTimeUntil(reminder.when)})</span>
              </p>
            </div>
            <div class="reminder-actions">
              <button class="snooze-btn" onclick="handleSnooze('${reminder.id}')" title="Posponer 5 min">
                üí§
              </button>
              <button class="delete-btn" onclick="handleDeleteReminder('${reminder.id}')" title="Eliminar">
                üóëÔ∏è
              </button>
            </div>
          </div>
        `,
          )
          .join("");
      }

      // Handlers globales para los botones
      (window as any).handleSnooze = (id: string) => {
        snoozeReminder(id, 5);
        renderReminders();
      };

      (window as any).handleDeleteReminder = (id: string) => {
        deleteReminder(id);
        renderReminders();
      };

      // Toggle reminder section
      document.addEventListener("DOMContentLoaded", () => {
        const toggleBtn = document.getElementById("toggle-reminder-section");
        const content = document.getElementById("reminder-content");

        if (toggleBtn && content) {
          toggleBtn.addEventListener("click", () => {
            content.classList.toggle("collapsed");
            toggleBtn.classList.toggle("collapsed");
          });
        }

        // Quick reminder buttons
        document.querySelectorAll(".quick-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const minutes = parseInt(btn.getAttribute("data-minutes") || "0");
            if (minutes > 0) {
              const when = Date.now() + minutes * 60 * 1000;
              const reminder = createReminder("custom", when);
              await addReminder(reminder);
              renderReminders();
            }
          });
        });

        // Custom reminder form
        const customForm = document.getElementById("custom-reminder-form");
        if (customForm) {
          customForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const form = e.target as HTMLFormElement;
            const timeInput = form.querySelector(
              '[name="time"]',
            ) as HTMLInputElement;
            const typeSelect = form.querySelector(
              '[name="type"]',
            ) as HTMLSelectElement;

            if (!timeInput.value) return;

            const [hours, minutes] = timeInput.value.split(":").map(Number);
            const now = new Date();
            const targetTime = new Date();
            targetTime.setHours(hours, minutes, 0, 0);

            // Si la hora ya pas√≥ hoy, programar para ma√±ana
            if (targetTime <= now) {
              targetTime.setDate(targetTime.getDate() + 1);
            }

            const type = typeSelect.value as "morning" | "evening" | "custom";
            const reminder = createReminder(type, targetTime.getTime());
            await addReminder(reminder);
            renderReminders();
            form.reset();
          });
        }

        // Permission button
        const permissionBtn = document.getElementById("request-permission-btn");
        const permissionNotice = document.getElementById(
          "notification-permission",
        );

        if (permissionBtn && permissionNotice) {
          // Check permission on load
          if (
            "Notification" in window &&
            Notification.permission === "default"
          ) {
            permissionNotice.style.display = "block";
          }

          permissionBtn.addEventListener("click", async () => {
            const permission = await requestNotificationPermission();
            if (permission === "granted") {
              permissionNotice.style.display = "none";
            }
          });
        }

        // Initialize reminders
        initReminders();
        renderReminders();

        // Update reminders list every minute
        setInterval(renderReminders, 60000);
      });

      // ==================== LOGROS Y DESAF√çOS ====================

      function getUserStats(): UserStats {
        // TODO: Obtener stats reales de Firebase
        const progressData = (window as any).currentProgressData || {};

        return {
          currentStreak: progressData.currentStreak || 0,
          longestStreak: progressData.longestStreak || 0,
          totalDaysCompleted: progressData.totalDaysCompleted || 0,
          perfectWeeks: 0, // TODO: calcular
          morningRoutines: 0, // TODO: obtener de Firebase
          nightRoutines: 0, // TODO: obtener de Firebase
          consecutiveDays: progressData.currentStreak || 0,
        };
      }

      function renderAchievements() {
        const grid = document.getElementById("achievements-grid");
        if (!grid) return;

        const stats = getUserStats();
        const unlockedAchievements = getUnlockedAchievements(stats);
        const unlockedIds = unlockedAchievements.map((a) => a.id);

        grid.innerHTML = ACHIEVEMENTS.map((achievement) => {
          const isUnlocked = unlockedIds.includes(achievement.id);
          const rarityMap = {
            common: "Com√∫n",
            rare: "Raro",
            epic: "√âpico",
            legendary: "Legendario",
          };
          return `
            <div class="achievement-item ${isUnlocked ? "unlocked" : "locked"}">
              <div class="achievement-rarity rarity-${achievement.rarity}">${rarityMap[achievement.rarity] || achievement.rarity}</div>
              <div class="achievement-icon">${achievement.icon}</div>
              <div class="achievement-content">
                <h4 class="achievement-name">${achievement.name}</h4>
                <p class="achievement-description">${achievement.description}</p>
              </div>
            </div>
          `;
        }).join("");

        // Update total
        const totalElement = document.getElementById("total-achievements");
        if (totalElement) {
          totalElement.textContent = `${unlockedAchievements.length}/${ACHIEVEMENTS.length}`;
        }
      }

      function renderCurrentChallenge() {
        const stats = getUserStats();
        const challenge = getCurrentChallenge(stats.currentStreak);

        const titleEl = document.getElementById("challenge-title");
        const descEl = document.getElementById("challenge-description");
        const progressFill = document.getElementById("challenge-progress-fill");
        const progressText = document.getElementById("challenge-progress-text");
        const rewardIcon = document.getElementById("challenge-reward-icon");
        const rewardName = document.getElementById("challenge-reward-name");

        if (titleEl) titleEl.textContent = challenge.title;
        if (descEl) descEl.textContent = challenge.description;

        const progress = Math.min(
          (challenge.current / challenge.target) * 100,
          100,
        );
        if (progressFill) progressFill.style.width = `${progress}%`;
        if (progressText)
          progressText.textContent = `${challenge.current}/${challenge.target} d√≠as`;

        if (rewardIcon) rewardIcon.textContent = challenge.reward.icon;
        if (rewardName) rewardName.textContent = challenge.reward.name;
      }

      // Initialize achievements
      document.addEventListener("DOMContentLoaded", () => {
        renderAchievements();
        renderCurrentChallenge();

        // Toggle button for achievements panel
        const achievementsToggleBtn = document.getElementById(
          "toggle-achievements-section",
        );
        const achievementsContent = document.getElementById(
          "achievements-content",
        );

        if (achievementsToggleBtn && achievementsContent) {
          achievementsToggleBtn.addEventListener("click", () => {
            achievementsContent.classList.toggle("collapsed");
            achievementsToggleBtn.classList.toggle("collapsed");
          });
        }

        // Update when progress changes
        window.addEventListener("progress-updated", () => {
          renderAchievements();
          renderCurrentChallenge();
        });
      });
    </script>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <BottomNav />
  </body>
</html>
