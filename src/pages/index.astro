---
export const prerender = false; // Desactivar prerender para contenido din√°mico
import {
  dailyRoutine as hardcodedDaily,
  nightlyRoutineWithLactic as hardcodedNightlyLactic,
  nightlyRoutineWithoutLactic as hardcodedNightlyWithout,
} from "../data/routines";
import { getRoutines, createEmptyRoutineData } from "../utils/firebase";
import type { RoutineData, Product } from "../types/routine";
import Header from "../components/Header.astro";
import Calendar from "../components/Calendar.astro";
import ProductCard from "../components/ProductCard.astro";
import RoutineEditor from "../components/RoutineEditor.astro";
import AuthModal from "../components/AuthModal.astro";
import BottomNav from "../components/BottomNav.astro";

const now = new Date();
// üîπ Hora de Madrid
const madridHourStr = new Intl.DateTimeFormat("es-ES", {
  timeZone: "Europe/Madrid",
  hour12: false,
  hour: "2-digit",
}).format(now);
const horaActual = parseInt(madridHourStr, 10);

// üîπ D√≠a de la semana en Madrid
const dayOfWeek = new Intl.DateTimeFormat("es-ES", {
  timeZone: "Europe/Madrid",
  weekday: "long",
})
  .format(now)
  .toLowerCase();

const isDayTime = horaActual >= 6 && horaActual < 20;
const capitalizedDay = dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1);

// Cargar rutinas desde Firebase
let routineData: RoutineData;
let currentRoutine: Product[];

try {
  const data = await getRoutines();
  routineData = data || createEmptyRoutineData();
  
  if (isDayTime) {
    currentRoutine = routineData.dailyRoutine.filter(p => p.enabled).sort((a, b) => a.step - b.step);
  } else {
    currentRoutine = (routineData.nightlyRoutines[capitalizedDay] || [])
      .filter(p => p.enabled)
      .sort((a, b) => a.step - b.step);
  }
  
  // Si no hay rutinas guardadas, usar las hardcoded como fallback
  if (currentRoutine.length === 0) {
    const isLacticAcidDay = ["lunes", "mi√©rcoles", "viernes"].includes(dayOfWeek);
    const hardcodedRoutine = isDayTime
      ? hardcodedDaily
      : isLacticAcidDay
        ? hardcodedNightlyLactic
        : hardcodedNightlyWithout;
    
    // Convertir al formato Product
    currentRoutine = hardcodedRoutine.map((item, index) => ({
      ...item,
      id: `fallback-${index}`,
      routineType: isDayTime ? ('day' as const) : ('night' as const),
      frequency: 'daily' as const,
      enabled: true,
    }));
  }
} catch (error) {
  console.error('Error cargando rutinas:', error);
  // Fallback a rutinas hardcoded
  const isLacticAcidDay = ["lunes", "mi√©rcoles", "viernes"].includes(dayOfWeek);
  const hardcodedRoutine = isDayTime
    ? hardcodedDaily
    : isLacticAcidDay
      ? hardcodedNightlyLactic
      : hardcodedNightlyWithout;
  
  // Convertir al formato Product
  currentRoutine = hardcodedRoutine.map((item, index) => ({
    ...item,
    id: `fallback-${index}`,
    routineType: isDayTime ? ('day' as const) : ('night' as const),
    frequency: 'daily' as const,
    enabled: true,
  }));
}

const routineTitle = isDayTime ? "PROTOCOLO DIURNO" : "PROTOCOLO NOCTURNO";

const jsDateKey =
  now.getFullYear() +
  "-" +
  (now.getMonth() + 1).toString().padStart(2, "0") +
  "-" +
  now.getDate().toString().padStart(2, "0");

const jsRoutineType = isDayTime ? "diurno" : "nocturno";
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gu√≠a de Skincare</title>
    <link rel="manifest" href="/manifest.webmanifest" />
    <style>
      body {
        margin: 0;
        background-color: #000;
        color: #fff;
        font-family: "Space Mono", monospace;
        min-height: 100vh;
        background-image: radial-gradient(circle, #1a2a47, #000);
      }
      .intro-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 95%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        opacity: 1;
        transition:
          opacity 1s,
          visibility 1s;
        z-index: 100;
      }
      .intro-screen.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }
      h1 {
        font-size: 2.5rem;
        margin-bottom: 2rem;
        animation: scan-text 1s linear infinite alternate;
      }
      .iris-scan {
        width: 50px;
        height: 50px;
        border: 2px solid #00ffff;
        border-radius: 50%;
        animation: iris-pulse 2s ease-in-out infinite;
      }
      @keyframes iris-pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 10px #00ffff;
        }
        100% {
          transform: scale(1.5);
          box-shadow: 0 0 20px #00ffff;
        }
      }
      @keyframes scan-text {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(-5px);
        }
      }
      .main-content {
        max-width: 600px;
        margin: 0 auto;
        padding: 1rem;
        display: none;
        padding-top: 100px;
      }

      /* Logo m√≥vil */
      .mobile-logo {
        display: none; /* Oculto por defecto */
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        padding: 0.75rem 1rem;
        z-index: 45;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(0, 255, 255, 0.2);
      }

      .mobile-logo img {
        height: 40px;
        width: auto;
      }

      .mobile-user-btn {
        background: rgba(0, 255, 255, 0.2);
        border: 2px solid #00ffff;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }

      .mobile-user-btn:hover {
        background: rgba(0, 255, 255, 0.4);
        transform: scale(1.05);
      }

      /* Mostrar logo m√≥vil solo en m√≥vil */
      @media (max-width: 768px) {
        .mobile-logo {
          display: flex;
        }
        .main-content {
          padding-top: 70px; /* Espacio para el logo m√≥vil */
        }
      }

      .routine-title {
        text-align: center;
        margin-bottom: 2rem;
        font-size: 2rem;
        color: #00ffff;
      }
      .hidden {
        display: none !important;
      }
      .centered-button {
        display: flex;
        justify-content: center;
      }

      /* === ESTILOS DE PROGRESO === */
      .progress-title-main {
        font-family: "Phatt", sans-serif;
        font-size: 2rem;
        color: #00ffff;
        text-align: center;
        margin-bottom: 2rem;
        text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      }

      /* Tarjeta de racha principal */
      .streak-card {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
        box-shadow: 0 8px 30px rgba(255, 107, 107, 0.4);
        position: relative;
        overflow: hidden;
      }

      .streak-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: pulse 3s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 0.8; }
      }

      .streak-icon {
        font-size: 4rem;
        margin-bottom: 0.5rem;
        animation: flicker 2s ease-in-out infinite;
      }

      @keyframes flicker {
        0%, 100% { transform: scale(1); filter: brightness(1); }
        50% { transform: scale(1.1); filter: brightness(1.3); }
      }

      .streak-number {
        font-size: 3.5rem;
        font-weight: bold;
        line-height: 1;
        margin-bottom: 0.25rem;
      }

      .streak-label {
        font-size: 1.2rem;
        opacity: 0.95;
        font-weight: 500;
      }

      .streak-message {
        margin-top: 1rem;
        font-size: 1rem;
        font-weight: 500;
        opacity: 0.9;
      }

      /* Tarjetas de estad√≠sticas */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        padding: 1.5rem 1rem;
        text-align: center;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        border-color: #00ffff;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        transform: translateY(-4px);
      }

      .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #00ffff;
        line-height: 1;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
      }

      /* Barra de progreso semanal */
      .progress-section {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .progress-section-title {
        font-size: 1.1rem;
        color: #00ffff;
        margin-bottom: 1rem;
        font-weight: 600;
      }

      .progress-bar-container {
        width: 100%;
        height: 30px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        margin-bottom: 0.5rem;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #00ffff 0%, #00dddd 100%);
        border-radius: 15px;
        transition: width 1s ease;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        position: relative;
      }

      .progress-bar-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      .progress-text {
        text-align: center;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.8);
      }

      /* Calendario mini */
      .calendar-preview {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .calendar-preview-title {
        font-size: 1.1rem;
        color: #00ffff;
        margin-bottom: 1rem;
        font-weight: 600;
      }

      .week-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
      }

      .day-cell {
        aspect-ratio: 1;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
      }

      .day-cell.completed {
        background: linear-gradient(135deg, #00ff88 0%, #00ddaa 100%);
        border-color: #00ff88;
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
      }

      .day-cell.partial {
        background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
        border-color: #ffaa00;
      }

      .day-cell.today {
        border: 2px solid #00ffff;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      }

      .day-name {
        font-size: 0.65rem;
        opacity: 0.7;
        margin-bottom: 0.25rem;
      }

      /* Loading state progreso */
      .progress-loading {
        text-align: center;
        padding: 2rem;
        color: #00ffff;
      }

      .progress-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 255, 255, 0.2);
        border-top-color: #00ffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      /* üîë ESTILO MEJORADO DEL BOT√ìN */
      #mark-completed {
        padding: 12px 24px;
        font-size: 1.1rem;
        color: #000;
        background-color: #00ffff;
        border: 2px solid #00ffff;
        border-radius: 8px;
        cursor: pointer;
        transition:
          background-color 0.2s,
          color 0.2s,
          box-shadow 0.2s;
        text-transform: uppercase;
        font-weight: bold;
      }
      #mark-completed:hover {
        background-color: #00dddd;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
      }
      #mark-completed:active {
        background-color: #00bbbb;
        transform: translateY(1px);
      }

      /* Estilos de la lista de productos en columna */
      .product-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <AuthModal />
    
    <div id="intro-screen" class="intro-screen">
      <h1>Bienvenido a la gu√≠a de Skin Care</h1>
      <div class="iris-scan"></div>
    </div>

    <main id="main-content" class="main-content">
      <!-- Logo m√≥vil (solo visible en m√≥vil) -->
      <div class="mobile-logo">
        <img src="/images/logo.png" alt="Skincare Logo" />
        <button id="mobile-user-menu-btn" class="mobile-user-btn" title="Cuenta">
          üë§
        </button>
      </div>
      
      <Header />

      <div id="guide-view">
        <h1 class="routine-title">{routineTitle}</h1>
        <div class="centered-button" style="margin-bottom:16px;">
          <button id="mark-completed" type="button">Marcar como completada</button>
        </div>
        <!-- CONTROLES DE RECORDATORIO -->
        <div id="reminder-controls" style="margin-top:1rem; text-align:center;">
          <p style="margin-bottom:8px; color: #ccc;">Recordatorios</p>

          <div
            style="display:flex;gap:8px;justify-content:center;margin-bottom:8px"
          >
            <button
              id="rem-10"
              style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer"
              >10 min</button
            >
            <button
              id="rem-30"
              style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer"
              >30 min</button
            >
            <button
              id="rem-60"
              style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer"
              >1 h</button
            >
          </div>

          <form
            id="rem-custom-form"
            style="display:flex;gap:8px;justify-content:center;align-items:center;"
          >
            <input
              name="minutes"
              type="number"
              placeholder="Minutos"
              min="1"
              style="width:90px;padding:6px;border-radius:6px;border:1px solid #333;background:transparent;color:#fff;"
            />
            <button
              type="submit"
              style="padding:8px 12px;border-radius:8px;border:none;cursor:pointer"
              >Programar</button
            >
          </form>

          <div
            id="reminders-list"
            style="margin-top:12px; max-width:480px; margin-left:auto; margin-right:auto; color:#ddd; font-size:0.95rem;"
          >
          </div>
        </div>

        <div class="product-list">
          {
            currentRoutine.map((product) => (
              <ProductCard
                step={product.step}
                title={product.title}
                accessCode={product.accessCode}
                function={product.function}
                usage={product.usage}
                image={product.image}
              />
            ))
          }
        </div>
      </div>

      <div id="calendar-view" class="hidden">
        <Calendar />
      </div>

      <div id="progress-view" class="hidden">
        <h1 class="progress-title-main">Tu Progreso</h1>

        <div id="progress-loading" class="progress-loading">
          <div class="progress-loading-spinner"></div>
          <p>Cargando estad√≠sticas...</p>
        </div>

        <div id="progress-content" style="display: none;">
          <!-- Tarjeta principal de racha -->
          <div class="streak-card">
            <div class="streak-icon">üî•</div>
            <div class="streak-number" id="streak-number">0</div>
            <div class="streak-label">d√≠as de racha</div>
            <div class="streak-message" id="streak-message">¬°Sigue as√≠!</div>
          </div>

          <!-- Grid de estad√≠sticas -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üèÜ</div>
              <div class="stat-number" id="longest-streak">0</div>
              <div class="stat-label">R√©cord Personal</div>
            </div>

            <div class="stat-card">
              <div class="stat-icon">‚ú®</div>
              <div class="stat-number" id="total-completions">0</div>
              <div class="stat-label">Total Completadas</div>
            </div>

            <div class="stat-card">
              <div class="stat-icon">üìÖ</div>
              <div class="stat-number" id="days-active">0</div>
              <div class="stat-label">D√≠as Activos</div>
            </div>

            <div class="stat-card">
              <div class="stat-icon">üí™</div>
              <div class="stat-number" id="completion-rate">0%</div>
              <div class="stat-label">Tasa de √âxito</div>
            </div>
          </div>

          <!-- Progreso semanal -->
          <div class="progress-section">
            <div class="progress-section-title">Progreso esta semana</div>
            <div class="progress-bar-container">
              <div class="progress-bar-fill" id="progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progress-text">0 de 14 rutinas completadas</div>
          </div>

          <!-- Mini calendario de √∫ltima semana -->
          <div class="calendar-preview">
            <div class="calendar-preview-title">√öltimos 7 d√≠as</div>
            <div class="week-grid" id="week-calendar">
              <!-- Se llena din√°micamente -->
            </div>
          </div>
        </div>
      </div>

      <div id="routines-view" class="hidden">
        <RoutineEditor />
      </div>
    </main>

    <script is:inline>
      // PWA FIX 2: Registro manual del Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/sw.js")
          .then((reg) =>
            console.log("Service Worker registrado con √©xito:", reg.scope)
          )
          .catch((err) =>
            console.error("Error al registrar Service Worker:", err)
          );
      } // FIN DEL FIX PWA

      document.addEventListener("DOMContentLoaded", () => {
        const introScreen = document.getElementById("intro-screen");
        const mainContent = document.getElementById("main-content");

        // Verificar si ya se mostr√≥ la intro en esta sesi√≥n
        const introShown = sessionStorage.getItem('introShown');
        
        if (introShown) {
          // Si ya se mostr√≥, saltarla
          introScreen.classList.add("hidden");
          mainContent.style.display = "block";
        } else {
          // Primera vez, mostrar intro
          setTimeout(() => {
            introScreen.classList.add("hidden");
            setTimeout(() => {
              mainContent.style.display = "block";
              // Marcar que ya se mostr√≥
              sessionStorage.setItem('introShown', 'true');
            }, 1000);
          }, 3000);
        }

        const navButtons = document.querySelectorAll(".main-nav .nav-link");
        const bottomNavButtons = document.querySelectorAll("#bottom-nav .nav-item");
        const guideView = document.getElementById("guide-view");
        const calendarView = document.getElementById("calendar-view");
        const progressView = document.getElementById("progress-view");
        const routinesView = document.getElementById("routines-view");

        // Funci√≥n para activar una vista
        function activateView(viewName) {
          // Remover active de todos los botones
          navButtons.forEach((btn) => btn.classList.remove("active"));
          bottomNavButtons.forEach((btn) => btn.classList.remove("active"));
          
          // Ocultar todas las vistas
          guideView.classList.add("hidden");
          calendarView.classList.add("hidden");
          progressView.classList.add("hidden");
          routinesView.classList.add("hidden");
          
          // Activar la vista correspondiente
          if (viewName === "guide") {
            guideView.classList.remove("hidden");
            document.querySelector('[data-view="guide"]')?.classList.add("active");
          } else if (viewName === "calendar") {
            calendarView.classList.remove("hidden");
            document.querySelector('[data-view="calendar"]')?.classList.add("active");
          } else if (viewName === "progress") {
            progressView.classList.remove("hidden");
            document.querySelector('[data-view="progress"]')?.classList.add("active");
            // Cargar datos de progreso si no se han cargado
            if (window.loadProgressData) {
              window.loadProgressData();
            }
          } else if (viewName === "routines") {
            routinesView.classList.remove("hidden");
            document.querySelector('[data-view="routines"]')?.classList.add("active");
          }
        }

        // Event listeners para botones del header
        navButtons.forEach((button) => {
          button.addEventListener("click", () => {
            activateView(button.getAttribute('data-view') || 'guide');
          });
        });
        
        // Escuchar evento del bottom nav
        window.addEventListener('change-view', (e) => {
          activateView(e.detail);
        });

        // Bot√≥n de usuario m√≥vil
        const mobileUserBtn = document.getElementById('mobile-user-menu-btn');
        if (mobileUserBtn) {
          mobileUserBtn.addEventListener('click', () => {
            const authApi = window.authModal;
            const isAuth = !!(authApi && typeof authApi.isAuthenticated === 'function' && authApi.isAuthenticated());

            if (isAuth) {
              const logoutModal = document.getElementById('logout-modal');
              if (logoutModal) logoutModal.classList.remove('hidden');
            } else {
              const authModal = document.getElementById('auth-modal');
              if (authModal) authModal.classList.remove('hidden');
            }
          });
        }

        // Listener para actualizar progreso cuando se marca una rutina como completada
        window.addEventListener('routine-completed', () => {
          if (typeof window.loadProgressData === 'function') {
            window.loadProgressData(true);
          }
        });
      });
    </script>

    <script>
      import { auth, getProgressData } from '../utils/firebase';
      import { onAuthStateChanged } from 'firebase/auth';
      
      // Funci√≥n para cargar datos de progreso
      let progressDataLoaded = false;
      
      async function loadProgressData(forceReload = false) {
        if (progressDataLoaded && !forceReload) return; // Ya se carg√≥, no volver a cargar
        
        // Resetear elementos si es recarga
        if (forceReload) {
          const loadingEl = document.getElementById('progress-loading');
          const contentEl = document.getElementById('progress-content');
          if (loadingEl) {
            loadingEl.style.display = 'block';
            loadingEl.innerHTML = '<div class="progress-loading-spinner"></div><p>Cargando estad√≠sticas...</p>';
          }
          if (contentEl) contentEl.style.display = 'none';
          progressDataLoaded = false;
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
              const loadingEl = document.getElementById('progress-loading');
              if (loadingEl) {
                loadingEl.innerHTML = `
                  <p style="margin-bottom: 1rem;">üîí Inicia sesi√≥n para ver tu progreso</p>
                  <button 
                    onclick="window.dispatchEvent(new CustomEvent('open-auth-modal'))"
                    style="
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      border: none;
                      padding: 1rem 2rem;
                      border-radius: 12px;
                      font-size: 1rem;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.3s ease;
                    "
                  >
                    Iniciar Sesi√≥n
                  </button>
                `;
              }
              return;
            }

            try {
              const progressData = await getProgressData();
              
              if (!progressData) {
                const loadingEl = document.getElementById('progress-loading');
                if (loadingEl) {
                  loadingEl.innerHTML = `<p>Error cargando datos. Intenta de nuevo.</p>`;
                }
                return;
              }

              progressDataLoaded = true;

              // Ocultar loading y mostrar contenido
              const loadingEl = document.getElementById('progress-loading');
              const contentEl = document.getElementById('progress-content');
              if (loadingEl) loadingEl.style.display = 'none';
              if (contentEl) contentEl.style.display = 'block';

              // Actualizar racha actual
              const streakNumber = document.getElementById('streak-number');
              if (streakNumber) {
                streakNumber.textContent = String(progressData.currentStreak);
              }

              // Mensaje motivacional seg√∫n racha
              const streakMessage = document.getElementById('streak-message');
              if (streakMessage) {
                if (progressData.currentStreak === 0) {
                  streakMessage.textContent = '¬°Comienza tu racha hoy!';
                } else if (progressData.currentStreak < 3) {
                  streakMessage.textContent = '¬°Buen comienzo! üí™';
                } else if (progressData.currentStreak < 7) {
                  streakMessage.textContent = '¬°Vas muy bien! üåü';
                } else if (progressData.currentStreak < 30) {
                  streakMessage.textContent = '¬°Incre√≠ble constancia! üöÄ';
                } else {
                  streakMessage.textContent = '¬°Eres una leyenda! üëë';
                }
              }

              // Actualizar r√©cord personal
              const longestStreakEl = document.getElementById('longest-streak');
              if (longestStreakEl) {
                longestStreakEl.textContent = String(progressData.longestStreak);
              }

              // Total completadas
              const totalCompletionsEl = document.getElementById('total-completions');
              if (totalCompletionsEl) {
                totalCompletionsEl.textContent = String(progressData.totalCompletions);
              }

              // D√≠as activos
              const daysActive = Object.keys(progressData.completions).length;
              const daysActiveEl = document.getElementById('days-active');
              if (daysActiveEl) {
                daysActiveEl.textContent = String(daysActive);
              }

              // Tasa de √©xito
              const possibleCompletions = daysActive * 2;
              const completionRate = possibleCompletions > 0 
                ? Math.round((progressData.totalCompletions / possibleCompletions) * 100)
                : 0;
              const completionRateEl = document.getElementById('completion-rate');
              if (completionRateEl) {
                completionRateEl.textContent = `${completionRate}%`;
              }

              // Progreso semanal (√∫ltimos 7 d√≠as)
              const today = new Date();
              const last7Days = [];
              let weekCompletions = 0;
              
              for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push({ date: dateStr, data: progressData.completions[dateStr] });
                
                const dayData = progressData.completions[dateStr];
                if (dayData) {
                  if (dayData.morning?.completed) weekCompletions++;
                  if (dayData.night?.completed) weekCompletions++;
                }
              }

              const weekPercentage = (weekCompletions / 14) * 100;
              const progressBarEl = document.getElementById('progress-bar');
              if (progressBarEl) {
                progressBarEl.style.width = `${weekPercentage}%`;
              }
              const progressTextEl = document.getElementById('progress-text');
              if (progressTextEl) {
                progressTextEl.textContent = `${weekCompletions} de 14 rutinas completadas`;
              }

              // Mini calendario de √∫ltima semana
              const weekCalendar = document.getElementById('week-calendar');
              const dayNames = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
              
              if (weekCalendar) {
                weekCalendar.innerHTML = ''; // Limpiar antes de llenar
                last7Days.forEach((day, index) => {
                  const cell = document.createElement('div');
                  cell.className = 'day-cell';
                  
                  const dayData = day.data;
                  const morningDone = dayData?.morning?.completed;
                  const nightDone = dayData?.night?.completed;
                  
                  if (morningDone && nightDone) {
                    cell.classList.add('completed');
                    cell.innerHTML = `<span class="day-name">${dayNames[new Date(day.date).getDay()]}</span>‚úÖ`;
                  } else if (morningDone || nightDone) {
                    cell.classList.add('partial');
                    cell.innerHTML = `<span class="day-name">${dayNames[new Date(day.date).getDay()]}</span>‚ö°`;
                  } else {
                    cell.innerHTML = `<span class="day-name">${dayNames[new Date(day.date).getDay()]}</span>-`;
                  }
                  
                  if (index === 6) {
                    cell.classList.add('today');
                  }
                  
                  weekCalendar.appendChild(cell);
                });
              }

            } catch (error) {
              console.error('Error cargando progreso:', error);
              const loadingEl = document.getElementById('progress-loading');
              if (loadingEl) {
                loadingEl.innerHTML = `<p>Error cargando datos. Intenta de nuevo.</p>`;
              }
            }
          });
      }
      
      // Hacer la funci√≥n disponible globalmente
      (window as any).loadProgressData = loadProgressData;

      // ==================== FUNCIONES DE RUTINA ====================
      import { markRoutineComplete, isRoutineCompleted } from '../utils/firebase';

      // Funci√≥n para mostrar toast (debe estar definida en el scope global)
      function showToast(message: string) {
        if (typeof (window as any).showToast === 'function') {
          (window as any).showToast(message);
        } else {
          alert(message);
        }
      }

      // Funci√≥n para marcar rutina como completada
      async function markRoutineCompleted(routineType: string) {
        try {
          // Verificar autenticaci√≥n
          const user = await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
              unsubscribe();
              resolve(user);
            });
          });
          
          if (!user) {
            showToast('‚ö†Ô∏è Debes iniciar sesi√≥n para marcar rutinas');
            window.dispatchEvent(new CustomEvent('open-auth-modal'));
            return;
          }
          
          const todayKey = new Date().toISOString().split("T")[0];
          const firestoreRoutineType = routineType === "diurno" ? "morning" : "night";
          
          await markRoutineComplete(todayKey, firestoreRoutineType);
          
          // Actualizar UI
          const btnComplete = document.getElementById("mark-completed");
          if (btnComplete) {
            btnComplete.setAttribute('disabled', 'true');
            btnComplete.textContent = "‚úÖ Rutina completada";
            (btnComplete as HTMLButtonElement).style.opacity = "0.6";
            (btnComplete as HTMLButtonElement).style.cursor = "not-allowed";
          }
          
          // Disparar evento para actualizar progreso
          window.dispatchEvent(new CustomEvent('routine-completed'));
          
          showToast(`¬°Rutina ${routineType} completada! üéâ Ve a Progreso para ver tu racha.`);
        } catch (error) {
          console.error('Error marcando rutina:', error);
          showToast('‚ùå Error al marcar rutina. Verifica tu conexi√≥n e intenta de nuevo.');
        }
      }

      // Funci√≥n para verificar si ya est√° completada hoy
      async function checkTodayCompletion() {
        try {
          // Verificar autenticaci√≥n
          const user = await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
              unsubscribe();
              resolve(user);
            });
          });
          
          const btnComplete = document.getElementById("mark-completed");
          
          if (!user) {
            // No autenticado, mostrar modal al hacer clic
            btnComplete?.addEventListener("click", () => {
              showToast('‚ö†Ô∏è Debes iniciar sesi√≥n para marcar rutinas');
              window.dispatchEvent(new CustomEvent('open-auth-modal'));
            });
            return;
          }
          
          const todayKey = new Date().toISOString().split("T")[0];
          const currentRoutine = (window as any).currentRoutine || "diurno";
          const firestoreRoutineType = currentRoutine === "diurno" ? "morning" : "night";
          
          const alreadyDone = await isRoutineCompleted(todayKey, firestoreRoutineType);
          
          if (alreadyDone && btnComplete) {
            btnComplete.setAttribute('disabled', 'true');
            btnComplete.textContent = "‚úÖ Rutina completada";
            (btnComplete as HTMLButtonElement).style.opacity = "0.6";
            (btnComplete as HTMLButtonElement).style.cursor = "not-allowed";
          }
        } catch (error) {
          console.error('Error verificando completado:', error);
        }
      }

      // Hacer funciones disponibles globalmente
      (window as any).markRoutineCompleted = markRoutineCompleted;
      (window as any).checkTodayCompletion = checkTodayCompletion;
    </script>

    <script is:inline>
      // nombre de la clave en localStorage
      const REMINDERS_KEY = "skincareReminders_v1";
      const sessionTimers = {}; // timeouts en memoria (no se serializan)

      // Helpers de storage
      function loadReminders() {
        try {
          return JSON.parse(localStorage.getItem(REMINDERS_KEY) || "[]");
        } catch (e) {
          console.error("Error parseando recordatorios", e);
          return [];
        }
      }
      function saveReminders(list) {
        localStorage.setItem(REMINDERS_KEY, JSON.stringify(list));
      }

      // Asegura registro de service worker (si existe)
      async function ensureSWReady() {
        if (!("serviceWorker" in navigator)) return null;
        try {
          return await navigator.serviceWorker.ready;
        } catch (e) {
          console.warn("Service Worker no listo", e);
          return null;
        }
      }

      // Pedir permiso de notificaciones si hace falta
      function requestNotificationPermission() {
        if (!("Notification" in window)) return Promise.resolve("denied");
        if (Notification.permission === "granted")
          return Promise.resolve("granted");
        if (Notification.permission === "denied")
          return Promise.resolve("denied");
        return Notification.requestPermission();
      }

      // Mostrar un toast en-app como fallback
      function showToast(text) {
        let t = document.getElementById("sk-toast");
        if (!t) {
          t = document.createElement("div");
          t.id = "sk-toast";
          Object.assign(t.style, {
            position: "fixed",
            bottom: "20px",
            left: "50%",
            transform: "translateX(-50%)",
            background: "#111",
            padding: "10px 14px",
            borderRadius: "8px",
            color: "#fff",
            zIndex: 9999,
            opacity: "1",
          });
          document.body.appendChild(t);
        }
        t.textContent = text;
        t.style.opacity = "1";
        clearTimeout(t._hideTimer);
        t._hideTimer = setTimeout(() => (t.style.opacity = "0"), 4000);
      }

      // Enviar notificaci√≥n (intenta service worker, si no Notification())
      async function showNotification(title, body, data = {}) {
        if (!("Notification" in window)) {
          showToast(body || title);
          return;
        }

        const permission = Notification.permission;
        if (permission !== "granted") {
          showToast(body || title);
          return;
        }

        const reg = await ensureSWReady();
        const options = {
          body: body,
          tag: "skincare-reminder",
          renotify: false,
          data,
          // Ajusta iconos seg√∫n tu PWA (a√±ade los archivos)
          icon: "/icons/icon-192.png",
          badge: "/icons/icon-72.png",
        };

        try {
          if (reg && typeof reg.showNotification === "function") {
            // Mostramos desde el SW cuando sea posible
            reg.showNotification(title, options);
          } else {
            new Notification(title, options);
          }
        } catch (e) {
          console.warn(
            "No se pudo mostrar notificaci√≥n via SW, fallback a Notification",
            e
          );
          try {
            new Notification(title, options);
          } catch (err) {
            showToast(body || title);
          }
        }
      }

      // Disparar recordatorio (mark fired + notificaci√≥n)
      async function fireReminder(reminder) {
        // Marca como fired
        const list = loadReminders();
        const idx = list.findIndex((r) => r.id === reminder.id);
        if (idx !== -1) {
          list[idx].fired = true;
          saveReminders(list);
        }
        if (sessionTimers[reminder.id]) {
          clearTimeout(sessionTimers[reminder.id]);
          delete sessionTimers[reminder.id];
        }

        const title = `Recordatorio Skincare`;
        const body = `Es hora de tu rutina: ${reminder.title || "Rutina"}`;
        await showNotification(title, body, { id: reminder.id });
        renderReminders();
      }

      // Programar timeout en memoria (si queda tiempo)
      function scheduleReminder(reminder) {
        const remaining = reminder.when - Date.now();
        if (remaining <= 0) {
          // si ya pas√≥: disparar inmediatamente
          fireReminder(reminder);
          return;
        }
        const tid = setTimeout(() => fireReminder(reminder), remaining);
        sessionTimers[reminder.id] = tid;
      }

      // A√±adir recordatorio en X minutos
      function addReminderIn(minutes) {
        const titleElement = document.querySelector(".routine-title");
        const title = titleElement
          ? titleElement.textContent.trim()
          : "Rutina";
        const when = Date.now() + minutes * 60 * 1000;
        const reminder = {
          id: "r-" + Date.now(),
          when,
          minutes,
          title,
          fired: false,
        };

        const list = loadReminders();
        list.push(reminder);
        saveReminders(list);
        scheduleReminder(reminder);

        // Pedimos permiso (si el usuario acepta, la notificaci√≥n saldr√°)
        requestNotificationPermission().then((perm) => {
          if (perm !== "granted")
            showToast(
              "Permiso de notificaciones no concedido ‚Äî usar√© un aviso en la app."
            );
          else showToast("Recordatorio programado ‚úÖ");
        });

        renderReminders();
      }

      // Cancelar recordatorio
      function cancelReminder(id) {
        let list = loadReminders();
        list = list.filter((r) => r.id !== id);
        saveReminders(list);
        if (sessionTimers[id]) {
          clearTimeout(sessionTimers[id]);
          delete sessionTimers[id];
        }
        renderReminders();
      }

      // Render lista de recordatorios (simple)
      function renderReminders() {
        const container = document.getElementById("reminders-list");
        if (!container) return;
        const list = loadReminders().sort((a, b) => a.when - b.when);
        container.innerHTML = "";
        if (list.length === 0) {
          container.innerHTML =
            "<div style='opacity:0.5;color:#0ff;text-align:center'>No hay recordatorios activos</div>";
          return;
        }
        list.forEach((r) => {
          const div = document.createElement("div");
          div.className = "reminder-row";
          div.style =
            "display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-radius:8px;background:rgba(0,255,255,0.05);margin-bottom:8px;backdrop-filter:blur(4px);";

          const left = document.createElement("div");
          left.innerHTML = `<strong style="display:block;color:#0ff">${new Date(
            r.when
          ).toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
          })}</strong><small style="opacity:0.7;color:#ccc">${r.title}</small>`;

          const right = document.createElement("div");
          right.style = "display:flex;align-items:center;gap:6px";

          // ‚úÖ Mostrar check si ya se dispar√≥
          if (r.fired) {
            const span = document.createElement("span");
            span.textContent = "enviado";
            span.style.color = "#0ff";
            span.style.fontSize = "0.85rem";
            span.style.opacity = "0.7";
            right.appendChild(span);
          }

          // ‚ùå Bot√≥n de eliminar siempre disponible
          const btnCancel = document.createElement("button");
          btnCancel.innerHTML = "‚ùå";
          btnCancel.style =
            "padding:4px 8px;border-radius:6px;border:none;cursor:pointer;background:rgba(255,0,255,0.1);color:#ff5555;font-size:0.9rem;transition:0.2s;backdrop-filter:blur(2px)";
          btnCancel.title = "Eliminar recordatorio";
          btnCancel.addEventListener("mouseenter", () => {
            btnCancel.style.background = "rgba(255,0,255,0.3)";
            btnCancel.style.boxShadow = "0 0 6px #ff00ff";
          });
          btnCancel.addEventListener("mouseleave", () => {
            btnCancel.style.background = "rgba(255,0,255,0.1)";
            btnCancel.style.boxShadow = "none";
          });
          btnCancel.addEventListener("click", () => cancelReminder(r.id));
          right.appendChild(btnCancel);

          div.appendChild(left);
          div.appendChild(right);
          container.appendChild(div);
        });
      }

      // Inicializa: restaurar timers de localStorage
      function initReminders() {
        const list = loadReminders();
        list.forEach((r) => {
          if (!r.fired && r.when > Date.now()) scheduleReminder(r);
          else if (!r.fired && r.when <= Date.now()) {
            // algo qued√≥ pendiente, lo disparamos al iniciar
            fireReminder(r);
          }
        });
        renderReminders();
      }

      // Wire UI (botones)
      document.addEventListener("DOMContentLoaded", () => {
        const btn10 = document.getElementById("rem-10");
        const btn30 = document.getElementById("rem-30");
        const btn60 = document.getElementById("rem-60");
        const form = document.getElementById("rem-custom-form");

        if (btn10) btn10.addEventListener("click", () => addReminderIn(10));
        if (btn30) btn30.addEventListener("click", () => addReminderIn(30));
        if (btn60) btn60.addEventListener("click", () => addReminderIn(60));
        if (form) {
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            const minutes = parseInt(form.elements["minutes"].value, 10);
            if (!minutes || minutes <= 0)
              return showToast("Introduce un n√∫mero v√°lido de minutos");
            addReminderIn(minutes);
            form.reset();
          });
        }

        initReminders();
        
        // ==================== SEGUIMIENTO DE RUTINAS CON FIREBASE ====================
        
        // Usar las funciones globales del script de m√≥dulo
        // Determinar tipo de rutina basado en la hora
        const now = new Date();
        const madridHour = new Date(now.toLocaleString("en-US", { timeZone: "Europe/Madrid" })).getHours();
        const isDayTimeClient = madridHour >= 6 && madridHour < 20;
        const routineType = isDayTimeClient ? "diurno" : "nocturno";
        
        // Guardar en window para que checkTodayCompletion lo pueda usar
        window.currentRoutine = routineType;
        
        // Bot√≥n marcar como completada
        const btnComplete = document.getElementById("mark-completed");
        
        // Configurar listener del bot√≥n
        btnComplete?.addEventListener("click", () => {
          if (!btnComplete.disabled && window.markRoutineCompleted) {
            window.markRoutineCompleted(routineType);
          }
        });
        
        // Verificar si ya est√° completada hoy
        if (window.checkTodayCompletion) {
          window.checkTodayCompletion();
        }

        // Exponer para debugging
        window.skincareReminders = {
          addReminderIn,
          loadReminders,
          cancelReminder
        };
        
      });

      // üîÑ Recargar la lista de productos din√°micamente desde Firebase
      async function reloadProductList() {
        try {
          const { getRoutines } = await import('./src/utils/firebase.ts');
          const routineData = await getRoutines();
          if (!routineData) return;

          // Determinar si es de d√≠a o noche (hora Madrid)
          const now = new Date();
          const madridHour = new Date(now.toLocaleString("en-US", { timeZone: "Europe/Madrid" })).getHours();
          const isDayTime = madridHour >= 6 && madridHour < 20;

          // D√≠a de la semana en Madrid
          const dayOfWeek = new Intl.DateTimeFormat("es-ES", {
            timeZone: "Europe/Madrid",
            weekday: "long",
          }).format(now);
          const capitalizedDay = dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1);

          let products = [];
          if (isDayTime) {
            products = routineData.dailyRoutine.filter(p => p.enabled).sort((a, b) => a.step - b.step);
          } else {
            products = (routineData.nightlyRoutines[capitalizedDay] || [])
              .filter(p => p.enabled)
              .sort((a, b) => a.step - b.step);
          }

          // Renderizar productos
          const productList = document.querySelector('.product-list');
          if (productList && products.length > 0) {
            productList.innerHTML = products.map(product => `
              <div class="product-card" style="background-color: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 1rem; padding: 1.5rem; margin: 1rem 0; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: row; align-items: center; gap: 1.5rem; position: relative;">
                <div class="step-badge" style="position: absolute; top: -10px; left: -10px; background-color: #00ffff; color: black; border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2rem;">${product.step}</div>
                <img src="${product.image}" alt="${product.accessCode}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid #00ffff;" />
                <div style="flex-grow: 1;">
                  <h2 style="font-family: 'Phatt', sans-serif; font-size: 1.5rem; margin: 0; letter-spacing: 0.09em;">${product.title}</h2>
                  <h3 style="font-size: 1rem; font-style: italic; opacity: 0.7; margin: 0.5rem 0;">C√≥digo de Acceso: ${product.accessCode}</h3>
                  <p style="font-size: 1rem; line-height: 1.4; margin: 0.5rem 0; opacity: 0.9;"><strong>Funci√≥n:</strong> ${product.function}</p>
                  <p style="font-size: 1rem; line-height: 1.4; margin: 0.5rem 0; opacity: 0.9;"><strong>Modo de Empleo:</strong> ${product.usage}</p>
                </div>
              </div>
            `).join('');
          }
        } catch (error) {
          console.error('Error recargando productos:', error);
        }
      }

      // Detectar cambios en rutinas y recargar autom√°ticamente
      window.addEventListener('routines-updated', async function() {
        console.log('‚úÖ Rutinas actualizadas detectadas. Recargando productos...');
        await reloadProductList();
        
        // Mostrar notificaci√≥n
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#00ffff;color:#000;padding:12px 24px;border-radius:8px;z-index:9999;font-weight:bold;box-shadow:0 4px 12px rgba(0,255,255,0.5);';
        toast.textContent = '‚úÖ Rutinas actualizadas';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      });
    </script>

    <BottomNav />
  </body>
</html>
