---
// src/components/ChatWidget.astro
// Vista completa de chat con IA usando Google Gemini
---

<div id="chat-widget" class="chat-widget">
  <h1 class="chat-title">üí¨ Chat con IA</h1>
  <p class="chat-subtitle">Preg√∫ntame sobre tus productos y rutinas de skincare</p>
  
  <div class="chat-messages" id="chat-messages">
    <div class="chat-message assistant-message">
      <div class="message-avatar">ü§ñ</div>
      <div class="message-content">
        <p>¬°Hola! üëã Soy tu asistente de skincare con IA.</p>
        <p>Puedo ayudarte con dudas sobre tus productos, rutinas, ingredientes y m√°s. ¬øEn qu√© puedo ayudarte hoy?</p>
      </div>
    </div>
  </div>

  <div class="chat-input-container">
    <textarea 
      id="chat-input" 
      class="chat-input"
      placeholder="Preg√∫ntame sobre skincare..."
      autocomplete="off"
      rows="1"
    ></textarea>
    <button id="chat-send-btn" class="chat-send-btn" title="Enviar">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <path d="M2 3l16 7-16 7V3zm2 11.5V13l8-3-8-3v-3.5l11 6.5-11 6.5z"/>
      </svg>
    </button>
  </div>

  <div class="chat-loading" id="chat-loading" style="display: none;">
    <div class="loading-dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
</div>

<style>
  .chat-widget {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    height: calc(100vh - 160px);
    display: flex;
    flex-direction: column;
    padding: 0;
  }

  .chat-title {
    font-family: 'Phatt', sans-serif;
    font-size: 2rem;
    color: #00ffff;
    text-align: center;
    margin: 0;
    padding: 1rem 1rem 0.5rem;
    text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
  }

  .chat-subtitle {
    text-align: center;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.95rem;
    margin: 0;
    padding: 0 1rem 1rem;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background: rgba(10, 10, 20, 0.6);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(0, 255, 255, 0.3);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 255, 255, 0.2);
    margin: 0 1rem;
    min-height: 0;
  }

  .chat-messages::-webkit-scrollbar {
    width: 6px;
  }

  .chat-messages::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }

  .chat-messages::-webkit-scrollbar-thumb {
    background: rgba(0, 255, 255, 0.3);
    border-radius: 3px;
  }

  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 255, 255, 0.5);
  }

  .chat-message {
    display: flex;
    gap: 0.75rem;
    width: 100%;
    align-items: flex-end;
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
  }

  .assistant-message .message-avatar {
    background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%);
  }

  .user-message {
    flex-direction: row-reverse;
    justify-content: flex-end;
  }

  .user-message .message-avatar {
    background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
  }

  .message-content {
    /* Burbuja como en apps de chat con ancho fijo */
    flex: 0 1 auto;
    display: inline-block;
    width: 100%;
    max-width: 280px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    color: #e0e0e0;
    line-height: 1.5;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    white-space: pre-wrap;
    box-sizing: border-box;
  }

  .assistant-message .message-content {
    background: rgba(0, 255, 255, 0.05);
    border-color: rgba(0, 255, 255, 0.2);
  }

  .user-message .message-content {
    background: rgba(147, 51, 234, 0.1);
    border-color: rgba(147, 51, 234, 0.3);
    text-align: left;
  }

  .message-content p {
    margin: 0 0 0.5rem 0;
    background: transparent !important;
    padding: 0 !important;
  }

  .message-content p:last-child {
    margin-bottom: 0;
  }

  /* Formato para listas */
  .message-content ul,
  .message-content ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
  }

  .message-content li {
    margin: 0.25rem 0;
  }

  /* Formato para c√≥digo o texto destacado */
  .message-content strong {
    color: #00ffff;
    font-weight: 600;
  }

  .message-content code {
    background: rgba(0, 0, 0, 0.3);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
  }

  .chat-input-container {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    border-top: 1px solid rgba(0, 255, 255, 0.2);
    background: rgba(0, 0, 0, 0.3);
  }

  .chat-input {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    color: #fff;
    font-size: 0.95rem;
    font-family: inherit;
    outline: none;
    transition: all 0.3s ease;
    resize: none;
    min-height: 44px;
    max-height: 150px;
    overflow-y: auto;
    line-height: 1.5;
  }

  .chat-input:focus {
    border-color: #00ffff;
    box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.1);
  }

  .chat-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  .chat-send-btn {
    background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%);
    border: none;
    border-radius: 12px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #000;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .chat-send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 255, 255, 0.4);
  }

  .chat-send-btn:active {
    transform: translateY(0);
  }

  .chat-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .chat-loading {
    position: absolute;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 20px;
    padding: 0.5rem 1rem;
    backdrop-filter: blur(10px);
  }

  .loading-dots {
    display: flex;
    gap: 0.4rem;
    align-items: center;
  }

  .loading-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #00ffff;
    animation: bounce 1.4s infinite ease-in-out both;
  }

  .loading-dots span:nth-child(1) {
    animation-delay: -0.32s;
  }

  .loading-dots span:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes bounce {
    0%, 80%, 100% {
      transform: scale(0);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .chat-widget {
      /* Usar dvh (dynamic viewport height) que se adapta al teclado */
      height: calc(100dvh - 70px);
      max-width: 100%;
      padding: 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 70px;
      margin: 0;
    }

    /* Ocultar cabecera en m√≥vil para ganar altura √∫til */
    .chat-title {
      font-size: 1.2rem;
      padding: 0.75rem 1rem 0.25rem;
      margin: 0;
    }

    .chat-subtitle {
      font-size: 0.8rem;
      padding: 0 1rem 0.5rem;
      margin: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      margin: 0;
      padding: 0.75rem;
      min-height: 0;
      /* Hacer scroll suave en m√≥vil */
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }

    .message-avatar {
      width: 28px;
      height: 28px;
      font-size: 1rem;
    }

    .message-content {
      font-size: 0.9rem;
      padding: 0.65rem 0.85rem;
      max-width: 240px;
    }

    .chat-input-container {
      padding: 0.75rem 1rem;
      /* A√±adir padding para safe-area en iOS */
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
      gap: 0.5rem;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(20px);
      border-top: 2px solid rgba(0, 255, 255, 0.3);
      margin: 0;
      flex-shrink: 0;
      border-radius: 0;
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      z-index: 100;
    }

    .chat-input {
      font-size: 0.9rem;
      padding: 0.65rem 0.85rem;
      min-height: 40px;
      max-height: 120px;
    }

    .chat-send-btn {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
      border-radius: 8px;
    }

    .chat-loading {
      bottom: 60px;
    }
  }

  /* Animaci√≥n de env√≠o */
  @keyframes slideUpIn {
    from { transform: translateY(10px); opacity: 0.6; }
    to { transform: translateY(0); opacity: 1; }
  }

  .chat-message.sending .message-content {
    animation: slideUpIn 200ms ease-out;
  }

  /* Ajustes para pantallas muy peque√±as */
  @media (max-width: 360px) {
    .chat-messages {
      margin: 0 0.25rem;
      padding: 0.5rem;
    }

    .message-content {
      font-size: 0.85rem;
      padding: 0.5rem 0.75rem;
      max-width: 200px;
    }

    .chat-input-container {
      padding: 0.5rem 0.75rem;
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
    }

    .chat-input {
      font-size: 0.85rem;
      padding: 0.5rem 0.75rem;
    }

    .chat-send-btn {
      width: 36px;
      height: 36px;
    }
  }

  /* Fix para iOS Safari */
  @supports (-webkit-touch-callout: none) {
    @media (max-width: 768px) {
      .chat-widget {
        /* En iOS usar altura que se ajusta con el viewport din√°mico */
        height: -webkit-fill-available;
        min-height: -webkit-fill-available;
      }
      
      .chat-messages {
        /* Ajustar padding inferior para compensar el input */
        padding-bottom: 1rem;
      }
      
      .chat-input-container {
        /* Asegurar que el input est√© siempre visible en iOS */
        position: fixed;
        bottom: calc(70px + env(safe-area-inset-bottom, 0px));
      }
    }
  }
</style>

<script>
  import { sendMessage, startChatSession, isGeminiConfigured } from '../utils/gemini';

  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;
  const sendBtn = document.getElementById('chat-send-btn') as HTMLButtonElement;
  const chatLoading = document.getElementById('chat-loading');

  // Verificar que Gemini est√© configurado
  if (!isGeminiConfigured()) {
    console.error('‚ö†Ô∏è Gemini API no est√° configurada');
  }

  // Iniciar sesi√≥n de chat al cargar
  startChatSession();

  // Auto-resize textarea
  function autoResizeTextarea() {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
  }

  chatInput.addEventListener('input', autoResizeTextarea);

  // Funci√≥n para formatear texto markdown b√°sico
  function formatMarkdown(text: string): string {
    // Convertir **negrita** a <strong>
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    // Convertir `c√≥digo` a <code>
    text = text.replace(/`(.+?)`/g, '<code>$1</code>');
    
    // Convertir listas numeradas
    text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<li>$2</li>');
    
    // Convertir listas con guiones/asteriscos
    text = text.replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>');
    
    return text;
  }

  // Funci√≥n para agregar mensaje al chat
  function addMessage(content: string, isUser: boolean = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${isUser ? 'user-message sending' : 'assistant-message'}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = isUser ? 'üë§' : 'ü§ñ';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    // Aplicar formato markdown
    let formattedContent = formatMarkdown(content);
    
    // Convertir saltos de l√≠nea a <p>
    const paragraphs = formattedContent.split('\n').filter(p => p.trim());
    
    // Detectar si hay listas y envolverlas
    let html = '';
    let inList = false;
    
    for (const p of paragraphs) {
      if (p.includes('<li>')) {
        if (!inList) {
          html += '<ul>';
          inList = true;
        }
        html += p;
      } else {
        if (inList) {
          html += '</ul>';
          inList = false;
        }
        html += `<p>${p}</p>`;
      }
    }
    
    if (inList) {
      html += '</ul>';
    }
    
    contentDiv.innerHTML = html;
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentDiv);
    
    if (chatMessages) {
      chatMessages.appendChild(messageDiv);
      
      // Hacer scroll suave al √∫ltimo mensaje
      requestAnimationFrame(() => {
        chatMessages.scrollTo({
          top: chatMessages.scrollHeight,
          behavior: 'smooth'
        });
      });
    }

    // Quitar la clase 'sending' al terminar la animaci√≥n
    if (isUser) {
      messageDiv.addEventListener('animationend', () => {
        messageDiv.classList.remove('sending');
      }, { once: true });
    }
  }

  // Funci√≥n para enviar mensaje
  async function handleSendMessage() {
    if (!chatInput || !chatInput.value.trim()) return;
    
    const userMessage = chatInput.value.trim();
    chatInput.value = '';
    chatInput.style.height = 'auto';
    
    // Agregar mensaje del usuario
    addMessage(userMessage, true);
    
    // Deshabilitar input y bot√≥n
    chatInput.disabled = true;
    sendBtn.disabled = true;
    if (chatLoading) chatLoading.style.display = 'block';
    
    try {
      // Enviar a Gemini
      const response = await sendMessage(userMessage);
      
      // Agregar respuesta de la IA
      addMessage(response, false);
    } catch (error) {
      console.error('Error al enviar mensaje:', error);
      addMessage('‚ùå Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta de nuevo.', false);
    } finally {
      // Rehabilitar input y bot√≥n
      chatInput.disabled = false;
      sendBtn.disabled = false;
      if (chatLoading) chatLoading.style.display = 'none';
      chatInput.focus();
    }
  }

  // Event listeners para el bot√≥n de enviar
  if (sendBtn) {
    // Click normal (PC y m√≥vil)
    sendBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      handleSendMessage();
    });
    
    // Touch espec√≠fico para m√≥vil
    sendBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      e.stopPropagation();
      handleSendMessage();
    }, { passive: false });
  }
  
  // Event listener para Enter en el textarea
  if (chatInput) {
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSendMessage();
      }
    });
  }

  // Focus autom√°tico al cargar la vista (solo en desktop)
  document.addEventListener('DOMContentLoaded', () => {
    // No hacer autofocus en m√≥viles para evitar que salte el teclado autom√°ticamente
    const isMobile = window.innerWidth <= 768;
    if (!isMobile && chatInput) {
      setTimeout(() => {
        chatInput.focus();
        autoResizeTextarea();
      }, 100);
    }
  });

  // ==================== MANEJO DEL TECLADO M√ìVIL ====================
  
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  
  // Detectar cuando el teclado aparece y ajustar scroll
  if (chatInput && isMobile) {
    chatInput.addEventListener('focus', () => {
      // Delay para que el teclado se abra completamente
      setTimeout(() => {
        // Scroll suave al final de los mensajes
        if (chatMessages) {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }, 400);
    });

    // Mantener scroll al final mientras escribe
    chatInput.addEventListener('input', () => {
      if (chatMessages) {
        requestAnimationFrame(() => {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
      }
    });
  }

  // Manejar el Visual Viewport API (mejor para m√≥viles)
  if ('visualViewport' in window && isMobile) {
    const viewport = window.visualViewport!;
    
    viewport.addEventListener('resize', () => {
      // Cuando cambia el viewport (teclado), ajustar contenedor del chat
      if (chatMessages && document.activeElement === chatInput) {
        requestAnimationFrame(() => {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
      }
    });

    viewport.addEventListener('scroll', () => {
      // Prevenir scroll no deseado cuando aparece el teclado
      if (document.activeElement === chatInput) {
        window.scrollTo(0, 0);
      }
    });
  }

  // Fallback para Android (algunos navegadores no soportan visualViewport bien)
  let initialHeight = window.innerHeight;
  window.addEventListener('resize', () => {
    if (!isMobile) return;
    
    const currentHeight = window.innerHeight;
    const heightDiff = initialHeight - currentHeight;
    
    // Si la altura disminuy√≥ m√°s de 150px, el teclado apareci√≥
    if (heightDiff > 150 && chatMessages && document.activeElement === chatInput) {
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 150);
    }
    
    // Si la altura aument√≥, el teclado desapareci√≥
    if (heightDiff < -100) {
      initialHeight = currentHeight;
    }
  });
</script>
