---
// El Calendar ahora carga datos del cliente, no del servidor
const days = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];

const now = new Date();
const todayFormatter = new Intl.DateTimeFormat('es-ES', {
  timeZone: 'Europe/Madrid',
  weekday: 'long'
});
const todayFull = todayFormatter.format(now);
const capitalizedToday = todayFull.charAt(0).toUpperCase() + todayFull.slice(1);
---<div class="calendar-container">
  <div class="days-of-week">
    {days.map(day => (
      <button 
        class={`day-button ${day === capitalizedToday ? 'active' : ''}`} 
        data-day={day.toLowerCase()}
      >
        {day.slice(0, 1)}
      </button>
    ))}
  </div>
  <div class="daily-routine-display">
    <div class="routine-section">
      <h3 class="routine-title">PROTOCOLO DIURNO</h3>
      <div id="daily-routine-products" class="routine-products-container">
        <!-- Se llenará dinámicamente desde el cliente -->
        <p style="text-align:center;opacity:0.7;">Cargando...</p>
      </div>
    </div>
    <div class="routine-section">
      <h3 class="routine-title">PROTOCOLO NOCTURNO</h3>
      <div class="nightly-routines-wrapper">
        {days.map(day => (
          <div 
            id={`nightly-products-${day.toLowerCase()}`} 
            class={`nightly-products-container ${day !== capitalizedToday ? 'ocultar' : ''}`}
          >
            <!-- Se llenará dinámicamente desde el cliente -->
            <p style="text-align:center;opacity:0.7;">Cargando...</p>
          </div>
        ))}
      </div>
    </div>
  </div>
</div>

<style>
  .ocultar {
    display: none !important;
  }
  .calendar-container {
    padding-top: 2rem;
  }
  .days-of-week {
    display: flex;
    justify-content: space-around;
    margin-bottom: 1.5rem;
  }
  .day-button {
    background: none;
    border: 2px solid #00ffff;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.2rem;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
  }
  .day-button:hover {
    background-color: rgba(0, 255, 255, 0.2);
  }
  .day-button.active {
    background-color: #00ffff;
    color: black;
  }
  .routine-section {
    margin-bottom: 2rem;
  }
  .routine-title {
    font-family: 'Phatt', sans-serif;
    color: #00ffff;
    font-size: 1.5rem;
    margin-bottom: 1rem;
    text-align: center;
  }
  .routine-products-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  .nightly-products-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  :global(.calendar-product) {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    width: 100%;
    background-color: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(0, 255, 255, 0.1);
  }
  :global(.calendar-product img) {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 50%;
    border: 2px solid #00ffff;
    flex-shrink: 0;
  }
  :global(.calendar-product p) {
    margin: 0;
    font-size: 0.95rem;
    color: white;
    flex-grow: 1;
  }
</style>

<script>
  import { getRoutines, waitForAuth } from '../utils/firebase';
  
  async function loadCalendarData() {
    try {
      // Esperar autenticación
      const user = await waitForAuth();
      if (!user) {
        console.log('No hay usuario autenticado para el calendario');
        return;
      }

      // Cargar rutinas desde Firebase
      const routineData = await getRoutines();
      if (!routineData) {
        console.log('No hay rutinas guardadas');
        return;
      }

      // Renderizar rutina diurna
      const dailyContainer = document.getElementById('daily-routine-products');
      if (dailyContainer && routineData.dailyRoutine) {
        const dailyRoutine = routineData.dailyRoutine
          .filter(p => p.enabled)
          .sort((a, b) => a.step - b.step);
        
        if (dailyRoutine.length === 0) {
          dailyContainer.innerHTML = '<p style="text-align:center;opacity:0.7;">No hay productos en la rutina diurna</p>';
        } else {
          dailyContainer.innerHTML = dailyRoutine.map(product => `
            <div class="calendar-product">
              <img src="${product.image}" alt="${product.accessCode}" />
              <p>${product.accessCode}</p>
            </div>
          `).join('');
        }
      }

      // Renderizar rutinas nocturnas
      const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
      days.forEach(day => {
        const container = document.getElementById(`nightly-products-${day.toLowerCase()}`);
        if (container && routineData.nightlyRoutines) {
          const nightRoutine = (routineData.nightlyRoutines[day] || [])
            .filter(p => p.enabled)
            .sort((a, b) => a.step - b.step);
          
          if (nightRoutine.length === 0) {
            container.innerHTML = '<p style="text-align:center;opacity:0.7;">No hay productos para este día</p>';
          } else {
            container.innerHTML = nightRoutine.map(product => `
              <div class="calendar-product">
                <img src="${product.image}" alt="${product.accessCode}" />
                <p>${product.accessCode}</p>
              </div>
            `).join('');
          }
        }
      });

    } catch (error) {
      console.error('Error cargando datos del calendario:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.day-button');
    const allNightlyRoutines = document.querySelectorAll('.nightly-products-container');

    buttons.forEach(button => {
      button.addEventListener('click', () => {
        const day = (button as HTMLElement).dataset.day;

        // Quitar la clase 'active' de todos los botones
        buttons.forEach(btn => btn.classList.remove('active'));
        // Ocultar todas las rutinas de noche
        allNightlyRoutines.forEach(routine => routine.classList.add('ocultar'));

        // Añadir la clase 'active' al botón clickeado
        button.classList.add('active');

        // Mostrar la rutina del día correspondiente
        const routineToShow = document.querySelector(`#nightly-products-${day}`);
        if (routineToShow) {
          routineToShow.classList.remove('ocultar');
        }
      });
    });

    // Cargar datos cuando se cargue la página
    loadCalendarData();

    // Escuchar cambios de autenticación y actualizar rutinas
    window.addEventListener('auth-changed', () => {
      // Recargar datos cuando cambia el usuario
      loadCalendarData();
    });

    // Escuchar actualizaciones de rutinas desde el editor
    window.addEventListener('routines-updated', () => {
      loadCalendarData();
    });
  });
</script>