---
// src/components/AuthModal.astro
// Modal de autenticaci√≥n
---

<div id="auth-modal" class="auth-modal hidden">
  <div class="auth-modal-content">
    <h2 class="auth-title">Iniciar Sesi√≥n</h2>
    
    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">Entrar</button>
      <button class="auth-tab" data-tab="register">Registrarse</button>
    </div>

    <!-- Tab de Login -->
    <div id="login-tab" class="auth-tab-content active">
      <form id="login-form" class="auth-form">
        <div class="form-group">
          <label for="login-email">Email:</label>
          <input type="email" id="login-email" required />
        </div>
        <div class="form-group">
          <label for="login-password">Contrase√±a:</label>
          <input type="password" id="login-password" required />
        </div>
        <button type="submit" class="btn-primary">Iniciar Sesi√≥n</button>
      </form>
    </div>

    <!-- Tab de Registro -->
    <div id="register-tab" class="auth-tab-content">
      <form id="register-form" class="auth-form">
        <div class="form-group">
          <label for="register-email">Email:</label>
          <input type="email" id="register-email" required />
        </div>
        <div class="form-group">
          <label for="register-password">Contrase√±a (m√≠n. 6 caracteres):</label>
          <input type="password" id="register-password" required minlength="6" />
        </div>
        <button type="submit" class="btn-primary">Crear Cuenta</button>
      </form>
    </div>

    <!-- Separador -->
    <div class="auth-divider">
      <span>O continuar con</span>
    </div>

    <!-- Botones sociales -->
    <div class="auth-social">
      <button id="btn-google" class="btn-social btn-google">
        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><path d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z" fill="#EA4335"/><path d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z" fill="#4285F4"/><path d="M3.88 10.78A5.54 5.54 0 0 1 3.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.92-2.26z" fill="#FBBC05"/><path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z" fill="#34A853"/></svg>
        Google
      </button>
      <button id="btn-anonymous" class="btn-social btn-anonymous">
        üï∂Ô∏è Modo An√≥nimo
      </button>
    </div>

    <div id="auth-error" class="auth-error hidden"></div>
    <div id="auth-success" class="auth-success hidden"></div>

    <!-- Info de usuario actual -->
    <div id="user-info" class="user-info hidden">
      <p>Sesi√≥n iniciada como: <strong id="user-email"></strong></p>
      <button id="btn-logout" class="btn-logout">Cerrar Sesi√≥n</button>
    </div>
  </div>
</div>

<!-- Modal de confirmaci√≥n de logout -->
<div id="logout-modal" class="logout-modal hidden">
  <div class="logout-modal-content">
    <h3 class="logout-title">Cerrar Sesi√≥n</h3>
    <p class="logout-message">¬øEst√°s seguro de que quieres cerrar sesi√≥n?</p>
    <div class="logout-actions">
      <button id="btn-logout-cancel" class="btn-cancel">Cancelar</button>
      <button id="btn-logout-confirm" class="btn-confirm">S√≠, cerrar sesi√≥n</button>
    </div>
  </div>
</div>

<style>
  .auth-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 1rem;
    /* Ensure full-viewport on mobile address-bar changes */
    min-height: 100dvh;
    overflow-y: auto;
  }

  /* Utilidad global para ocultar elementos con class="hidden" */
  .hidden { display: none !important; }

  .auth-modal.hidden {
    display: none;
  }

  .auth-modal-content {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 2px solid #00ffff;
    border-radius: 1.5rem;
    padding: 2rem;
    max-width: 450px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
    box-sizing: border-box;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
  }

  .auth-title {
    color: #00ffff;
    text-align: center;
    margin: 0 0 1.5rem 0;
    font-size: 1.8rem;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
  }

  .auth-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .auth-tab {
    flex: 1;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1rem;
  }

  .auth-tab.active {
    background: rgba(0, 255, 255, 0.2);
    border-color: #00ffff;
    color: #00ffff;
    font-weight: bold;
  }

  .auth-tab-content {
    display: none;
  }

  .auth-tab-content.active {
    display: block;
  }

  .auth-form {
    margin-bottom: 1.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #00ffff;
    font-size: 0.9rem;
  }

  .form-group input {
    width: 100%;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 8px;
    color: white;
    font-size: 16px;
    transition: all 0.3s;
  }

  .form-group input:focus {
    outline: none;
    border-color: #00ffff;
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
  }

  .btn-primary, .btn-secondary, .btn-social, .btn-logout {
    width: 100%;
    padding: 0.85rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 0.5rem;
  }

  .btn-primary {
    background: #00ffff;
    color: #000;
  }

  .btn-primary:hover {
    background: #00dddd;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: rgba(0, 255, 255, 0.2);
    color: #00ffff;
    border: 1px solid #00ffff;
  }

  .btn-secondary:hover {
    background: rgba(0, 255, 255, 0.3);
  }

  .auth-divider {
    text-align: center;
    margin: 1.5rem 0;
    position: relative;
  }

  .auth-divider::before,
  .auth-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: rgba(0, 255, 255, 0.3);
  }

  .auth-divider::before {
    left: 0;
  }

  .auth-divider::after {
    right: 0;
  }

  .auth-divider span {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.9rem;
    padding: 0 1rem;
    background: #1a1a2e;
  }

  .auth-social {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .btn-social {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .btn-google:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.4);
  }

  .btn-anonymous {
    background: rgba(138, 43, 226, 0.2);
    border-color: rgba(138, 43, 226, 0.5);
  }

  .btn-anonymous:hover {
    background: rgba(138, 43, 226, 0.3);
    border-color: rgba(138, 43, 226, 0.7);
  }

  .auth-error, .auth-success {
    padding: 0.75rem;
    border-radius: 8px;
    margin-top: 1rem;
    text-align: center;
  }

  .auth-error {
    background: rgba(255, 0, 0, 0.1);
    border: 1px solid rgba(255, 0, 0, 0.3);
    color: #ff5555;
  }

  .auth-success {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid rgba(0, 255, 0, 0.3);
    color: #55ff55;
  }

  .auth-error.hidden, .auth-success.hidden {
    display: none;
  }

  .user-info {
    padding: 1rem;
    background: rgba(0, 255, 255, 0.05);
    border: 1px solid rgba(0, 255, 255, 0.2);
    border-radius: 8px;
    margin-top: 1rem;
  }

  .user-info p {
    color: #ccc;
    margin-bottom: 1rem;
    text-align: center;
  }

  .user-info strong {
    color: #00ffff;
  }

  .btn-logout {
    background: rgba(255, 0, 0, 0.2);
    color: #ff5555;
    border: 1px solid rgba(255, 0, 0, 0.3);
  }

  .btn-logout:hover {
    background: rgba(255, 0, 0, 0.3);
    border-color: rgba(255, 0, 0, 0.5);
  }

  /* M√≥vil: asegurar que el modal no se salga */
  @media (max-width: 480px) {
    .auth-modal {
      padding: calc(0.5rem + env(safe-area-inset-top)) calc(0.5rem + env(safe-area-inset-right)) calc(0.5rem + env(safe-area-inset-bottom)) calc(0.5rem + env(safe-area-inset-left));
      align-items: center;
      overflow-y: auto;
      min-height: 100dvh;
    }

    .auth-modal-content {
      padding: 0.9rem;
      border-radius: 0.9rem;
      max-width: 90%;
      width: 100%;
      margin: 0 auto;
      max-height: calc(100dvh - 2rem - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      box-sizing: border-box;
    }

    .auth-title {
      font-size: 1.25rem;
      margin-bottom: 0.85rem;
    }

    .auth-tabs {
      gap: 0.25rem;
      margin-bottom: 0.85rem;
    }

    .auth-tab {
      padding: 0.55rem 0.45rem;
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 0.7rem;
    }

    .form-group label {
      font-size: 0.85rem;
      margin-bottom: 0.35rem;
    }

    .form-group input {
      padding: 0.65rem;
      font-size: 16px; /* Prevenir zoom en iOS */
    }

    .btn-primary, .btn-secondary, .btn-social, .btn-logout {
      padding: 0.7rem;
      font-size: 0.95rem;
    }

    .auth-social {
      gap: 0.5rem;
      margin: 0.85rem 0;
    }

    .auth-divider {
      margin: 0.85rem 0;
    }

    .auth-divider span {
      font-size: 0.85rem;
    }

    .user-info p {
      font-size: 0.9rem;
    }
  }

  /* A√∫n m√°s compacto en <= 480px */
  @media (max-width: 480px) {
    .auth-title { font-size: 1.15rem; }
    .auth-tab { font-size: 0.85rem; padding: 0.5rem 0.4rem; }
    .btn-primary, .btn-secondary, .btn-social, .btn-logout { font-size: 0.9rem; padding: 0.65rem; }
  }

  /* Muy peque√±o (iPhone SE, 320-360px) */
  @media (max-width: 360px) {
    .auth-modal-content { padding: 0.75rem; border-radius: 0.75rem; }
    .auth-title { font-size: 1.05rem; }
    .auth-tab { font-size: 0.8rem; padding: 0.45rem 0.35rem; }
    .form-group label { font-size: 0.8rem; }
    .btn-primary, .btn-secondary, .btn-social, .btn-logout { font-size: 0.85rem; padding: 0.6rem; }
  }

  /* Estilos para el modal de logout */
  .logout-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    min-height: 100dvh;
    padding: 1rem;
  }

  .logout-modal.hidden {
    display: none;
  }

  .logout-modal-content {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 2px solid #00ffff;
    border-radius: 1.5rem;
    padding: 2rem;
    max-width: 400px;
    width: 100%;
    box-sizing: border-box;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
    text-align: center;
  }

  .logout-title {
    color: #00ffff;
    margin: 0 0 1rem 0;
    font-size: 1.5rem;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
  }

  .logout-message {
    color: white;
    margin: 0 0 1.5rem 0;
    font-size: 1.1rem;
    line-height: 1.5;
  }

  .logout-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  .btn-cancel,
  .btn-confirm {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    flex: 1;
    max-width: 150px;
  }

  .btn-cancel {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  .btn-cancel:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
  }

  .btn-confirm {
    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
    color: white;
    border: 2px solid #ff6666;
  }

  .btn-confirm:hover {
    background: linear-gradient(135deg, #ff6666 0%, #ff0000 100%);
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
    transform: translateY(-2px);
  }

  /* Logout modal responsive en m√≥viles */
  @media (max-width: 480px) {
    .logout-modal {
      padding: calc(0.5rem + env(safe-area-inset-top)) calc(0.5rem + env(safe-area-inset-right)) calc(0.5rem + env(safe-area-inset-bottom)) calc(0.5rem + env(safe-area-inset-left));
    }

    .logout-modal-content {
      padding: 1.5rem 1rem;
      border-radius: 1rem;
      max-width: 90%;
    }

    .logout-title {
      font-size: 1.2rem;
      margin-bottom: 0.85rem;
    }

    .logout-message {
      font-size: 0.95rem;
      margin-bottom: 1.2rem;
    }

    .logout-actions {
      gap: 0.65rem;
      flex-direction: column;
    }

    .btn-cancel,
    .btn-confirm {
      padding: 0.7rem 1rem;
      font-size: 0.95rem;
      max-width: 100%;
    }
  }

  /* Muy peque√±o (iPhone SE, 320-360px) */
  @media (max-width: 360px) {
    .logout-modal-content {
      padding: 1.2rem 0.85rem;
      border-radius: 0.85rem;
    }

    .logout-title {
      font-size: 1.1rem;
    }

    .logout-message {
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .btn-cancel,
    .btn-confirm {
      padding: 0.65rem 0.85rem;
      font-size: 0.9rem;
    }
  }

  /* Global helpers to prevent horizontal overflow and lock scroll when modal open */
  :global(html), :global(body) { max-width: 100%; overflow-x: hidden; }
  :global(html.no-scroll), :global(body.no-scroll) { overflow: hidden; touch-action: none; overscroll-behavior: contain; }
</style>

<script>
  import { 
    signInWithEmail, 
    signUpWithEmail, 
    signInWithGoogle, 
    signInAnonymous,
    signOut,
    getCurrentUser,
    waitForAuth,
    migrateHardcodedRoutines,
    checkAndAutoImportRoutines
  } from '../utils/firebase';

  let isAuthenticated = false;

  // Inicializar
  document.addEventListener('DOMContentLoaded', async () => {
    // Esperar a que se inicialice Firebase Auth
    const user = await waitForAuth();
    
    if (user) {
      isAuthenticated = true;
      showUserInfo(user);
    } else {
      // Asegurar vista de login (sin bot√≥n de cerrar sesi√≥n visible)
      hideUserInfo();
      showAuthModal();
    }

    setupEventListeners();
  });

  function setupEventListeners() {
    // Tabs
    const authTabs = document.querySelectorAll('.auth-tab');
    authTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = (tab as HTMLElement).dataset.tab;
        switchAuthTab(tabName!);
      });
    });

    // Forms
    const loginForm = document.getElementById('login-form') as HTMLFormElement;
    const registerForm = document.getElementById('register-form') as HTMLFormElement;
    
    if (loginForm) loginForm.addEventListener('submit', handleLogin);
    if (registerForm) registerForm.addEventListener('submit', handleRegister);

    // Botones sociales
    const btnGoogle = document.getElementById('btn-google');
    const btnAnonymous = document.getElementById('btn-anonymous');
    
    if (btnGoogle) btnGoogle.addEventListener('click', handleGoogleLogin);
    if (btnAnonymous) btnAnonymous.addEventListener('click', handleAnonymousLogin);

    // Bot√≥n de logout
    const btnLogout = document.getElementById('btn-logout');
    if (btnLogout) btnLogout.addEventListener('click', handleLogout);

    // Botones del modal de logout
    const btnLogoutCancel = document.getElementById('btn-logout-cancel');
    const btnLogoutConfirm = document.getElementById('btn-logout-confirm');
    if (btnLogoutCancel) btnLogoutCancel.addEventListener('click', cancelLogout);
    if (btnLogoutConfirm) btnLogoutConfirm.addEventListener('click', confirmLogout);
  }

  // Bloqueo de scroll de fondo: fija el body y recuerda la posici√≥n
  let __scrollY = 0;
  function lockScroll() {
    try {
      __scrollY = window.scrollY || window.pageYOffset || 0;
      document.documentElement.classList.add('no-scroll');
      document.body.classList.add('no-scroll');
      document.body.style.position = 'fixed';
      document.body.style.top = `-${__scrollY}px`;
      document.body.style.left = '0';
      document.body.style.right = '0';
      document.body.style.width = '100%';
    } catch {}
  }

  function unlockScroll() {
    try {
      document.body.classList.remove('no-scroll');
      document.documentElement.classList.remove('no-scroll');
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.left = '';
      document.body.style.right = '';
      document.body.style.width = '';
      const y = __scrollY || 0;
      window.scrollTo(0, y);
    } catch {}
  }

  function switchAuthTab(tab: string) {
    const tabs = document.querySelectorAll('.auth-tab');
    const contents = document.querySelectorAll('.auth-tab-content');
    
    tabs.forEach(t => {
      if ((t as HTMLElement).dataset.tab === tab) {
        t.classList.add('active');
      } else {
        t.classList.remove('active');
      }
    });

    contents.forEach(c => {
      if (c.id === `${tab}-tab`) {
        c.classList.add('active');
      } else {
        c.classList.remove('active');
      }
    });

    hideMessages();
  }

  async function handleLogin(e: Event) {
    e.preventDefault();
    hideMessages();

    const form = e.target as HTMLFormElement;
    const email = (form.elements.namedItem('login-email') as HTMLInputElement).value;
    const password = (form.elements.namedItem('login-password') as HTMLInputElement).value;

    try {
      const user = await signInWithEmail(email, password);
      showSuccess('¬°Sesi√≥n iniciada correctamente!');
      
      // Auto-importar rutinas si es primera vez (no bloquear cierre del modal)
      try { await checkAndAutoImportRoutines(); } catch (e) { console.warn('Auto-import fall√≥ (no bloqueante):', e); }
      
      showUserInfo(user);
      isAuthenticated = true;
      
      // Cerrar el modal despu√©s de 1 segundo pase lo que pase
      setTimeout(() => { hideAuthModal(); }, 1000);
      
      // Disparar evento para que otros componentes se enteren
      window.dispatchEvent(new CustomEvent('auth-changed', { detail: { user } }));
    } catch (error: any) {
      showError(error.message);
    }
  }

  async function handleRegister(e: Event) {
    e.preventDefault();
    hideMessages();

    const form = e.target as HTMLFormElement;
    const email = (form.elements.namedItem('register-email') as HTMLInputElement).value;
    const password = (form.elements.namedItem('register-password') as HTMLInputElement).value;

    try {
      const user = await signUpWithEmail(email, password);
      showSuccess('¬°Cuenta creada! Bienvenido üéâ');
      
      // Auto-importar rutinas en el registro (no bloqueante)
      try { await checkAndAutoImportRoutines(); } catch (e) { console.warn('Auto-import fall√≥ (no bloqueante):', e); }
      
      showUserInfo(user);
      isAuthenticated = true;
      
      setTimeout(() => { hideAuthModal(); }, 1000);
      
      window.dispatchEvent(new CustomEvent('auth-changed', { detail: { user } }));
    } catch (error: any) {
      showError(error.message);
    }
  }

  async function handleGoogleLogin() {
    hideMessages();
    try {
      const user = await signInWithGoogle();
      showSuccess('¬°Sesi√≥n iniciada con Google!');
      
      try { await checkAndAutoImportRoutines(); } catch (e) { console.warn('Auto-import fall√≥ (no bloqueante):', e); }
      
      showUserInfo(user);
      isAuthenticated = true;
      
      setTimeout(() => { hideAuthModal(); }, 1000);
      
      window.dispatchEvent(new CustomEvent('auth-changed', { detail: { user } }));
    } catch (error: any) {
      showError(error.message);
    }
  }

  async function handleAnonymousLogin() {
    hideMessages();
    try {
      const user = await signInAnonymous();
      showSuccess('¬°Modo an√≥nimo activado!');
      
      // No bloquear por auto-import fallido (por ejemplo sin conexi√≥n)
      try { await checkAndAutoImportRoutines(); } catch (e) { console.warn('Auto-import fall√≥ (no bloqueante):', e); }
      
      showUserInfo(user);
      isAuthenticated = true;
      
      setTimeout(() => { hideAuthModal(); }, 1000);
      
      window.dispatchEvent(new CustomEvent('auth-changed', { detail: { user } }));
    } catch (error: any) {
      showError(error.message);
    }
  }

  async function handleLogout() {
    // Mostrar modal de confirmaci√≥n
    const logoutModal = document.getElementById('logout-modal');
    if (logoutModal) {
      logoutModal.classList.remove('hidden');
      lockScroll();
    }
  }

  // Manejar la confirmaci√≥n del logout
  async function confirmLogout() {
    const logoutModal = document.getElementById('logout-modal');
    if (logoutModal) {
      logoutModal.classList.add('hidden');
    }
    
    try {
      await signOut();
      isAuthenticated = false;
      
      // Limpiar la informaci√≥n del usuario y mostrar formularios de login
      const userEmailSpan = document.getElementById('user-email');
      if (userEmailSpan) userEmailSpan.textContent = '';
      
      hideUserInfo(); // Esto muestra los tabs, botones sociales, etc.
      showAuthModal();
      
      showSuccess('Sesi√≥n cerrada correctamente');
      window.dispatchEvent(new CustomEvent('auth-changed', { detail: { user: null } }));
    } catch (error) {
      showError('Error al cerrar sesi√≥n');
    }
  }

  // Manejar la cancelaci√≥n del logout
  function cancelLogout() {
    const logoutModal = document.getElementById('logout-modal');
    if (logoutModal) {
      logoutModal.classList.add('hidden');
      // Si no hay otro modal abierto, reactivar el scroll de fondo
      const auth = document.getElementById('auth-modal');
      if (!auth || auth.classList.contains('hidden')) {
        unlockScroll();
      }
    }
  }

  async function handleImportHardcoded() {
    if (!confirm('¬øImportar las rutinas predeterminadas? Solo funciona si no tienes rutinas guardadas.')) return;
    
    try {
      await migrateHardcodedRoutines();
      alert('‚úÖ Rutinas importadas correctamente! Recarga la p√°gina para verlas.');
      window.location.reload();
    } catch (error: any) {
      alert(`‚ùå ${error.message}`);
    }
  }

  function showUserInfo(user: any) {
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');
    const authSocial = document.querySelector('.auth-social');
    const authTabs = document.querySelector('.auth-tabs');
    
    if (userInfo && userEmail) {
      userEmail.textContent = user.email || 'An√≥nimo';
      userInfo.classList.remove('hidden');
    }
    
    if (loginTab) loginTab.classList.add('hidden');
    if (registerTab) registerTab.classList.add('hidden');
    if (authSocial) (authSocial as HTMLElement).style.display = 'none';
    if (authTabs) (authTabs as HTMLElement).style.display = 'none';
  }

  function hideUserInfo() {
    const userInfo = document.getElementById('user-info');
    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');
    const authSocial = document.querySelector('.auth-social');
    const authTabs = document.querySelector('.auth-tabs');
    
    if (userInfo) userInfo.classList.add('hidden');
    if (loginTab) loginTab.classList.remove('hidden');
    if (registerTab) registerTab.classList.remove('hidden');
    if (authSocial) (authSocial as HTMLElement).style.display = 'flex';
    if (authTabs) (authTabs as HTMLElement).style.display = 'flex';
  }

  function showAuthModal() {
    const modal = document.getElementById('auth-modal');
    if (modal) modal.classList.remove('hidden');
    lockScroll();
  }

  function hideAuthModal() {
    const modal = document.getElementById('auth-modal');
    if (modal) modal.classList.add('hidden');
    unlockScroll();
  }

  function showError(message: string) {
    const errorEl = document.getElementById('auth-error');
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }
  }

  function showSuccess(message: string) {
    const successEl = document.getElementById('auth-success');
    if (successEl) {
      successEl.textContent = message;
      successEl.classList.remove('hidden');
      setTimeout(() => successEl.classList.add('hidden'), 3000);
    }
  }

  function hideMessages() {
    const errorEl = document.getElementById('auth-error');
    const successEl = document.getElementById('auth-success');
    if (errorEl) errorEl.classList.add('hidden');
    if (successEl) successEl.classList.add('hidden');
  }

  // Exponer para debugging
  if (typeof window !== 'undefined') {
    (window as any).authModal = {
      show: showAuthModal,
      hide: hideAuthModal,
      isAuthenticated: () => isAuthenticated,
    };
  }
</script>
